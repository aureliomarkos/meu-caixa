<!DOCTYPE html>
<html class="light" lang="pt-br">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Contas a Receber | Meu Caixa</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#10b981",
                        "primary-600": "#059669",
                        "primary-700": "#047857",
                        "background-light": "#f8fafc",
                        "background-dark": "#0f172a",
                        "danger": "#ef4444",
                        "warning": "#f59e0b",
                        "success": "#10b981",
                    },
                    fontFamily: {
                        "display": ["Inter"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style type="text/tailwindcss">
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .sidebar-item-active {
            @apply bg-primary/10 text-primary border-r-4 border-primary;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            @apply bg-slate-200 dark:bg-zinc-800 rounded-full;
        }

        .status-badge {
            @apply px-2.5 py-1 text-[10px] font-bold uppercase tracking-wider rounded;
        }

        .status-pendente {
            @apply bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400;
        }

        .status-pago {
            @apply bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400;
        }

        .status-parcial {
            @apply bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400;
        }

        .status-atrasado {
            @apply bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400;
        }

        .card-hover {
            @apply transition-all duration-200 hover:shadow-xl hover:-translate-y-1;
        }

        .modal {
            @apply fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4;
        }

        .modal-content {
            @apply bg-white dark:bg-zinc-900 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto;
        }

        .form-group {
            @apply mb-4;
        }

        .form-label {
            @apply block text-sm font-semibold text-slate-700 dark:text-zinc-300 mb-2;
        }

        .form-input {
            @apply w-full bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all;
        }

        .btn {
            @apply px-4 py-2 rounded-lg text-sm font-bold transition-all;
        }

        .btn-primary {
            @apply bg-primary text-white hover:bg-primary-600 shadow-sm hover:shadow-md;
        }

        .btn-secondary {
            @apply bg-slate-100 dark:bg-zinc-800 text-slate-700 dark:text-zinc-300 hover:bg-slate-200 dark:hover:bg-zinc-700;
        }

        .btn-danger {
            @apply bg-red-500 text-white hover:bg-red-600 shadow-sm hover:shadow-md;
        }

        .stat-card {
            @apply bg-gradient-to-br p-6 rounded-xl text-white shadow-lg;
        }

        .view-content {
            @apply h-full w-full flex flex-col overflow-hidden;
        }

        .view-content:not(#receivablesView) {
            @apply overflow-y-auto p-4 md:p-8 pb-24;
        }

        .hidden {
            display: none !important;
        }
    </style>

    <style>
        /* Limpar seta padrão do select - Bloco de estilo padrão para máxima compatibilidade */
        select {
            appearance: none !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/1999/xlink' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5z' fill='%2364748b'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em;
        }

        select::-ms-expand {
            display: none;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-slate-100 antialiased overflow-hidden">
    <!-- Login Screen -->
    <div id="loginScreen"
        class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-primary/10 via-background-light to-blue-50 dark:from-primary/5 dark:via-background-dark dark:to-zinc-900">
        <div class="w-full max-w-md">
            <div
                class="bg-white dark:bg-zinc-900 rounded-2xl shadow-2xl p-8 border border-slate-200 dark:border-zinc-800">
                <div class="text-center mb-8">
                    <div
                        class="size-16 bg-primary rounded-xl flex items-center justify-center text-white mx-auto mb-4 shadow-lg">
                        <span class="material-symbols-outlined text-3xl">account_balance_wallet</span>
                    </div>
                    <h1 class="text-3xl font-black text-slate-900 dark:text-white tracking-tight">Meu Caixa</h1>
                    <p class="text-sm text-slate-500 dark:text-zinc-400 mt-1">Controle de Recebíveis</p>
                </div>
                <form id="loginForm" class="space-y-4">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="loginEmail" class="form-input" placeholder="seu@email.com" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Senha</label>
                        <input type="password" id="loginPassword" class="form-input" placeholder="••••••••" required />
                    </div>
                    <button type="submit" class="btn btn-primary w-full py-3 text-base">
                        Entrar
                    </button>
                </form>
                <div id="loginError"
                    class="hidden mt-4 p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-red-700 dark:text-red-400 text-sm">
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden flex h-screen overflow-hidden">
        <!-- Sidebar Backdrop for mobile -->
        <div id="sidebarBackdrop" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden" onclick="toggleSidebar()">
        </div>

        <!-- Sidebar -->
        <aside id="sidebar"
            class="fixed md:relative w-72 h-full bg-white dark:bg-zinc-900 border-r border-slate-200 dark:border-zinc-800 flex flex-col z-50 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
            <div class="p-6 flex items-center gap-3">
                <div class="size-10 bg-primary rounded-lg flex items-center justify-center text-white shadow-md">
                    <span class="material-symbols-outlined text-2xl">account_balance_wallet</span>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-slate-900 dark:text-white leading-none">Meu Caixa
                    </h1>
                    <p class="text-xs text-slate-500 dark:text-zinc-400 font-medium">Gestão Financeira</p>
                </div>
            </div>
            <nav class="flex-1 px-4 py-4 space-y-1">
                <a href="#"
                    class="nav-item flex items-center gap-3 px-3 py-2.5 bg-primary/10 text-primary rounded-lg transition-colors"
                    data-view="receivables">
                    <span class="material-symbols-outlined"
                        style="font-variation-settings: 'FILL' 1">receipt_long</span>
                    <span class="text-sm font-semibold">Contas a Receber</span>
                </a>
                <a href="#"
                    class="nav-item flex items-center gap-3 px-3 py-2.5 text-slate-600 dark:text-zinc-400 hover:bg-slate-50 dark:hover:bg-zinc-800 rounded-lg transition-colors"
                    data-view="sales">
                    <span class="material-symbols-outlined">point_of_sale</span>
                    <span class="text-sm font-semibold">Nova Venda</span>
                </a>
                <div class="pt-4 pb-2">
                    <p class="px-3 text-xs font-bold text-slate-400 dark:text-zinc-500 uppercase tracking-wider">
                        Cadastros</p>
                </div>
                <a href="#"
                    class="nav-item flex items-center gap-3 px-3 py-2.5 text-slate-600 dark:text-zinc-400 hover:bg-slate-50 dark:hover:bg-zinc-800 rounded-lg transition-colors"
                    data-view="clients">
                    <span class="material-symbols-outlined">person</span>
                    <span class="text-sm font-semibold">Clientes</span>
                </a>
                <a href="#"
                    class="nav-item flex items-center gap-3 px-3 py-2.5 text-slate-600 dark:text-zinc-400 hover:bg-slate-50 dark:hover:bg-zinc-800 rounded-lg transition-colors"
                    data-view="products">
                    <span class="material-symbols-outlined">inventory_2</span>
                    <span class="text-sm font-semibold">Produtos</span>
                </a>
                <a href="#"
                    class="nav-item flex items-center gap-3 px-3 py-2.5 text-slate-600 dark:text-zinc-400 hover:bg-slate-50 dark:hover:bg-zinc-800 rounded-lg transition-colors"
                    data-view="suppliers">
                    <span class="material-symbols-outlined">local_shipping</span>
                    <span class="text-sm font-semibold">Fornecedores</span>
                </a>
                <a href="#"
                    class="nav-item flex items-center gap-3 px-3 py-2.5 text-slate-600 dark:text-zinc-400 hover:bg-slate-50 dark:hover:bg-zinc-800 rounded-lg transition-colors"
                    data-view="categories">
                    <span class="material-symbols-outlined">category</span>
                    <span class="text-sm font-semibold">Categorias</span>
                </a>
                <a href="#"
                    class="nav-item flex items-center gap-3 px-3 py-2.5 text-slate-600 dark:text-zinc-400 hover:bg-slate-50 dark:hover:bg-zinc-800 rounded-lg transition-colors"
                    data-view="employees">
                    <span class="material-symbols-outlined">badge</span>
                    <span class="text-sm font-semibold">Funcionários</span>
                </a>
                <div class="pt-4 pb-2">
                    <p class="px-3 text-xs font-bold text-slate-400 dark:text-zinc-500 uppercase tracking-wider">
                        Financeiro</p>
                </div>
                <a href="#"
                    class="nav-item flex items-center gap-3 px-3 py-2.5 text-slate-600 dark:text-zinc-400 hover:bg-slate-50 dark:hover:bg-zinc-800 rounded-lg transition-colors"
                    data-view="payables">
                    <span class="material-symbols-outlined">payments</span>
                    <span class="text-sm font-semibold">Contas a Pagar</span>
                </a>
                <a href="#"
                    class="nav-item flex items-center gap-3 px-3 py-2.5 text-slate-600 dark:text-zinc-400 hover:bg-slate-50 dark:hover:bg-zinc-800 rounded-lg transition-colors"
                    data-view="advances">
                    <span class="material-symbols-outlined">request_quote</span>
                    <span class="text-sm font-semibold">Adiantamentos</span>
                </a>
            </nav>
            <div class="p-4 border-t border-slate-100 dark:border-zinc-800 mt-auto">
                <div class="flex items-center gap-3 px-3 py-2">
                    <div class="size-10 rounded-full bg-primary/20 flex items-center justify-center text-primary font-bold text-sm"
                        id="userAvatar">
                        U
                    </div>
                    <div class="overflow-hidden flex-1">
                        <p class="text-sm font-bold truncate" id="userName">Usuário</p>
                        <p class="text-xs text-slate-500 truncate" id="userEmail">user@email.com</p>
                    </div>
                    <button class="text-slate-400 hover:text-primary transition-colors" id="darkModeToggle">
                        <span class="material-symbols-outlined text-xl">dark_mode</span>
                    </button>
                    <button class="text-slate-400 hover:text-red-500 transition-colors" id="logoutBtn">
                        <span class="material-symbols-outlined text-xl">logout</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden relative">
            <!-- Header -->
            <header
                class="h-16 bg-white dark:bg-zinc-900 border-b border-slate-200 dark:border-zinc-800 flex items-center justify-between px-4 md:px-8 z-10">
                <div class="flex items-center gap-3 flex-1 md:flex-none">
                    <!-- Mobile Menu Toggle -->
                    <button
                        class="md:hidden p-2 text-slate-600 dark:text-zinc-400 hover:bg-slate-100 dark:hover:bg-zinc-800 rounded-lg"
                        onclick="toggleSidebar()">
                        <span class="material-symbols-outlined">menu</span>
                    </button>

                    <div class="relative flex-1 md:w-96">
                        <span
                            class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xl">search</span>
                        <input id="searchInput"
                            class="w-full bg-slate-50 dark:bg-zinc-800 border-none rounded-lg pl-8 pr-4 py-2 text-sm focus:ring-2 focus:ring-primary/20 transition-all placeholder:text-slate-400"
                            placeholder="Buscar vendas, clientes..." type="text" />
                    </div>
                </div>
                <div class="flex items-center gap-2 md:gap-4 ml-2">
                </div>
            </header>

            <!-- Content Area -->
            <div class="flex-1 flex flex-col overflow-hidden bg-background-light dark:bg-background-dark">
                <!-- Receivables View (Default) -->
                <div id="receivablesView" class="view-content flex-1 flex flex-col p-4 md:p-8 mb-16 overflow-hidden">
                    <div class="flex flex-col md:flex-row md:items-end justify-between mb-8 gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 dark:text-white tracking-tight">Contas a
                                Receber</h2>
                            <p class="text-slate-500 dark:text-zinc-400 mt-1">Gerencie suas vendas e recebimentos</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <!-- View Toggle Buttons -->
                            <div class="flex bg-slate-100 dark:bg-zinc-800 p-1 rounded-xl">
                                <button id="salesGridViewBtn"
                                    class="p-2 rounded-lg transition-all bg-white dark:bg-zinc-900 text-primary shadow-sm"
                                    title="Ver como Cards">
                                    <span class="material-symbols-outlined text-lg block">grid_view</span>
                                </button>
                                <button id="salesTableViewBtn"
                                    class="p-2 rounded-lg transition-all text-slate-400 hover:text-primary"
                                    title="Ver como Tabela">
                                    <span class="material-symbols-outlined text-lg block">table_rows</span>
                                </button>
                            </div>

                            <div class="flex gap-2">
                                <button id="openFiltersBtn" class="btn btn-secondary flex items-center gap-2">
                                    <span class="material-symbols-outlined text-lg">filter_list</span>
                                    Filtros
                                </button>
                                <button class="btn btn-primary flex items-center gap-2" onclick="switchView('sales')">
                                    <span class="material-symbols-outlined text-lg">add_shopping_cart</span>
                                    Nova Venda
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
                        <div class="stat-card from-green-500 to-green-600">
                            <div class="flex items-center justify-between mb-2">
                                <span class="material-symbols-outlined text-3xl opacity-80">trending_up</span>
                                <span class="text-xs font-bold bg-white/20 px-2 py-1 rounded">Este Mês</span>
                            </div>
                            <p class="text-sm font-medium opacity-90">Total</p>
                            <p class="text-3xl font-black mt-1" id="totalReceivable">R$ 0,00</p>
                        </div>
                        <div class="stat-card from-blue-500 to-blue-600">
                            <div class="flex items-center justify-between mb-2">
                                <span class="material-symbols-outlined text-3xl opacity-80">check_circle</span>
                                <span class="text-xs font-bold bg-white/20 px-2 py-1 rounded">Recebido</span>
                            </div>
                            <p class="text-sm font-medium opacity-90">Valores Pagos</p>
                            <p class="text-3xl font-black mt-1" id="totalPaid">R$ 0,00</p>
                        </div>
                        <div class="stat-card from-yellow-500 to-yellow-600">
                            <div class="flex items-center justify-between mb-2">
                                <span class="material-symbols-outlined text-3xl opacity-80">schedule</span>
                                <span class="text-xs font-bold bg-white/20 px-2 py-1 rounded">Pendente</span>
                            </div>
                            <p class="text-sm font-medium opacity-90">Aguardando</p>
                            <p class="text-3xl font-black mt-1" id="totalPending">R$ 0,00</p>
                        </div>
                        <div class="stat-card from-red-500 to-red-600">
                            <div class="flex items-center justify-between mb-2">
                                <span class="material-symbols-outlined text-3xl opacity-80">warning</span>
                                <span class="text-xs font-bold bg-white/20 px-2 py-1 rounded">Atenção</span>
                            </div>
                            <p class="text-sm font-medium opacity-90">Parcial</p>
                            <p class="text-3xl font-black mt-1" id="totalPartial">R$ 0,00</p>
                        </div>
                    </div>

                    <!-- Sales List -->
                    <div
                        class="flex-1 min-h-0 bg-white dark:bg-zinc-900 rounded-xl border border-slate-200 dark:border-zinc-800 flex flex-col overflow-hidden">
                        <div class="p-6 border-b border-slate-200 dark:border-zinc-800 flex-none">
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white">Vendas Recentes</h3>
                        </div>
                        <div class="overflow-auto flex-1">
                            <div id="salesTableContainer">
                                <table class="w-full text-left border-collapse">
                                    <thead class="sticky top-0 z-10 bg-slate-50 dark:bg-zinc-800 shadow-sm">
                                        <tr
                                            class="border-b border-slate-100 dark:border-zinc-800 bg-slate-50/50 dark:bg-zinc-800/50">
                                            <th
                                                class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                                ID</th>
                                            <th
                                                class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                                Cliente</th>
                                            <th
                                                class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                                Data</th>
                                            <th
                                                class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                                Valor</th>
                                            <th
                                                class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                                Forma Pgto</th>
                                            <th
                                                class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                                Status</th>
                                            <th
                                                class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider text-right">
                                                Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="salesTableBody" class="divide-y divide-slate-100 dark:divide-zinc-800">
                                        <!-- Sales will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            <!-- Card View Container -->
                            <div id="salesGrid"
                                class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 p-6">
                                <!-- Cards will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Other Views (Placeholder) -->
                <div id="salesView" class="view-content hidden">
                    <div class="flex flex-col md:flex-row md:items-end justify-between mb-8 gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 dark:text-white tracking-tight">Nova Venda
                            </h2>
                            <p class="text-slate-500 dark:text-zinc-400 mt-1">Realize uma nova venda no sistema</p>
                        </div>
                    </div>

                    <div class="flex flex-col lg:flex-row gap-8">
                        <!-- Left Column: Products and Items -->
                        <div class="flex-1 space-y-6">
                            <div
                                class="bg-white dark:bg-zinc-900 rounded-2xl border border-slate-200 dark:border-zinc-800 p-6 shadow-sm">
                                <h3
                                    class="text-xl font-bold text-slate-900 dark:text-white mb-6 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-primary">shopping_cart</span>
                                    Itens da Venda
                                </h3>

                                <!-- Product Search -->
                                <div class="relative mb-6">
                                    <label class="form-label">Adicionar Produto</label>
                                    <div class="relative">
                                        <span
                                            class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">search</span>
                                        <input type="text" id="saleProductSearch" class="form-input !pl-9"
                                            placeholder="Buscar por nome ou código..." autocomplete="off" />

                                        <!-- Search Results Dropdown -->
                                        <div id="productSearchResults"
                                            class="hidden absolute top-full left-0 right-0 z-20 mt-1 bg-white dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-xl shadow-2xl max-h-64 overflow-y-auto">
                                            <!-- Results will be injected here -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Items Table -->
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left border-collapse">
                                        <thead class="border-b border-slate-100 dark:border-zinc-800">
                                            <tr class="hidden sm:table-row">
                                                <th
                                                    class="py-3 text-xs font-bold text-slate-500 uppercase tracking-wider">
                                                    Produto</th>
                                                <th
                                                    class="py-3 text-xs font-bold text-slate-500 uppercase tracking-wider">
                                                    Qtde</th>
                                                <th
                                                    class="py-3 text-xs font-bold text-slate-500 uppercase tracking-wider">
                                                    Preço</th>
                                                <th
                                                    class="py-3 text-xs font-bold text-slate-500 uppercase tracking-wider">
                                                    Total</th>
                                                <th
                                                    class="py-3 text-xs font-bold text-slate-500 uppercase tracking-wider">
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="saleItemsBody"
                                            class="divide-y divide-slate-100 dark:divide-zinc-800">
                                            <!-- Items will be injected here -->
                                        </tbody>
                                        <tfoot id="saleItemsEmpty" class="">
                                            <tr>
                                                <td colspan="5" class="py-12 text-center text-slate-400 italic">
                                                    Nenhum item adicionado
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Client and Payment -->
                        <div class="w-full lg:w-96 space-y-6">
                            <!-- Client Selection -->
                            <div
                                class="bg-white dark:bg-zinc-900 rounded-2xl border border-slate-200 dark:border-zinc-800 p-6 shadow-sm">
                                <h3
                                    class="text-lg font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-primary">person</span>
                                    Cliente
                                </h3>
                                <div class="relative">
                                    <select id="saleClientSelect" class="form-input appearance-none">
                                        <option value="">Cliente Ocasional (Balcão)</option>
                                        <!-- Clients will be injected here -->
                                    </select>
                                </div>
                            </div>

                            <!-- Payment and Total -->
                            <div
                                class="bg-white dark:bg-zinc-900 rounded-2xl border border-slate-200 dark:border-zinc-800 p-6 shadow-sm">
                                <h3
                                    class="text-lg font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-primary">payments</span>
                                    Pagamento
                                </h3>

                                <div class="space-y-4">
                                    <div>
                                        <label class="form-label">Forma de Pagamento</label>
                                        <select id="salePaymentMethod" class="form-input">
                                            <option value="Dinheiro">Dinheiro</option>
                                            <option value="Pix">Pix</option>
                                            <option value="Cartão Débito">Cartão Débito</option>
                                            <option value="Cartão Crédito">Cartão Crédito</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="form-label">Status</label>
                                        <select id="salePaymentStatus" class="form-input"
                                            onchange="toggleDownPaymentField()">
                                            <option value="Pago">Pago</option>
                                            <option value="Pendente">Pendente</option>
                                            <option value="Parcial">Parcial</option>
                                        </select>
                                    </div>
                                    <div id="saleDownPaymentGroup" class="hidden">
                                        <label class="form-label text-emerald-600 dark:text-emerald-400 font-bold">Valor
                                            de Entrada (R$)</label>
                                        <input type="number" step="0.01" id="saleDownPayment"
                                            class="form-input border-emerald-200 dark:border-emerald-900/50 bg-emerald-50/30"
                                            placeholder="0.00" />
                                    </div>

                                    <div class="pt-6 border-t border-slate-100 dark:border-zinc-800 space-y-2">
                                        <div class="flex justify-between text-slate-600 dark:text-zinc-400">
                                            <span>Subtotal</span>
                                            <span id="saleSubtotal">R$ 0,00</span>
                                        </div>
                                        <div
                                            class="flex justify-between text-xl font-black text-slate-900 dark:text-white">
                                            <span>Total</span>
                                            <span id="saleTotal">R$ 0,00</span>
                                        </div>
                                    </div>

                                    <button id="finishSaleBtn"
                                        class="btn btn-primary w-full py-4 text-lg mt-4 shadow-lg shadow-primary/20">
                                        Finalizar Venda
                                    </button>
                                    <button id="cancelSaleBtn" class="btn btn-secondary w-full py-2">
                                        Cancelar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="payablesView" class="view-content hidden">
                    <div class="flex flex-col md:flex-row md:items-end justify-between mb-8 gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 dark:text-white tracking-tight">Contas a Pagar
                            </h2>
                            <p class="text-slate-500 dark:text-zinc-400 mt-1">Gerencie seus débitos e compromissos</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <!-- View Toggle Buttons -->
                            <div class="flex bg-slate-100 dark:bg-zinc-800 p-1 rounded-xl">
                                <button id="payablesGridViewBtn" class="p-2 rounded-lg transition-all"
                                    title="Ver como Cards">
                                    <span class="material-symbols-outlined text-lg block">grid_view</span>
                                </button>
                                <button id="payablesTableViewBtn" class="p-2 rounded-lg transition-all"
                                    title="Ver como Tabela">
                                    <span class="material-symbols-outlined text-lg block">table_rows</span>
                                </button>
                            </div>

                            <div class="flex gap-2">
                                <button id="openFilterPayablesBtn" onclick="openFilterPayablesModal()"
                                    class="btn btn-secondary flex-1 md:flex-none flex items-center justify-center gap-2">
                                    <span class="material-symbols-outlined text-lg">filter_list</span>
                                    Filtros
                                </button>
                                <button onclick="openPayableModal()" class="btn btn-primary flex items-center gap-2">
                                    <span class="material-symbols-outlined text-lg">add</span>
                                    Nova Conta
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
                        <div class="stat-card from-rose-500 to-rose-600">
                            <div class="flex items-center justify-between mb-2">
                                <span class="material-symbols-outlined text-3xl opacity-80">account_balance</span>
                                <span class="text-xs font-bold bg-white/20 px-2 py-1 rounded">Total</span>
                            </div>
                            <p class="text-sm font-medium opacity-90">Total</p>
                            <p class="text-3xl font-black mt-1" id="totalPayable">R$ 0,00</p>
                        </div>
                        <div class="stat-card from-emerald-500 to-emerald-600">
                            <div class="flex items-center justify-between mb-2">
                                <span class="material-symbols-outlined text-3xl opacity-80">task_alt</span>
                                <span class="text-xs font-bold bg-white/20 px-2 py-1 rounded">Liquidado</span>
                            </div>
                            <p class="text-sm font-medium opacity-90">Valores Pagos</p>
                            <p class="text-3xl font-black mt-1" id="totalPayablePaid">R$ 0,00</p>
                        </div>
                        <div class="stat-card from-amber-500 to-amber-600">
                            <div class="flex items-center justify-between mb-2">
                                <span class="material-symbols-outlined text-3xl opacity-80">event_busy</span>
                                <span class="text-xs font-bold bg-white/20 px-2 py-1 rounded">Vencendo</span>
                            </div>
                            <p class="text-sm font-medium opacity-90">Em Aberto</p>
                            <p class="text-3xl font-black mt-1" id="totalPayablePending">R$ 0,00</p>
                        </div>
                        <div class="stat-card from-slate-600 to-slate-700">
                            <div class="flex items-center justify-between mb-2">
                                <span class="material-symbols-outlined text-3xl opacity-80">layers</span>
                                <span class="text-xs font-bold bg-white/20 px-2 py-1 rounded">Quantidade</span>
                            </div>
                            <p class="text-sm font-medium opacity-90">Contas Ativas</p>
                            <p class="text-3xl font-black mt-1" id="totalPayableCount">0</p>
                        </div>
                    </div>

                    <!-- Payables List -->
                    <div id="payablesTableContainer"
                        class="hidden bg-white dark:bg-zinc-900 rounded-xl border border-slate-200 dark:border-zinc-800 overflow-hidden shadow-sm">
                        <div class="p-6 border-b border-slate-200 dark:border-zinc-800">
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white">Relatório de Débitos</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr
                                        class="border-b border-slate-100 dark:border-zinc-800 bg-slate-50/50 dark:bg-zinc-800/50">
                                        <th
                                            class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                            Vencimento</th>
                                        <th
                                            class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                            Fornecedor</th>
                                        <th
                                            class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider text-center">
                                            NF/Doc</th>
                                        <th
                                            class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                            Valor</th>
                                        <th
                                            class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider text-center">
                                            Status</th>
                                        <th
                                            class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider text-right">
                                            Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="payablesTableBody" class="divide-y divide-slate-50 dark:divide-zinc-800/50">
                                    <!-- Payables rows will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Card View Container -->
                    <div id="payablesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <!-- Cards will be injected here -->
                    </div>

                </div>

                <!-- Advances View -->
                <div id="advancesView" class="view-content hidden">
                    <div class="flex flex-col md:flex-row md:items-end justify-between mb-8 gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 dark:text-white tracking-tight">Adiantamentos
                            </h2>
                            <p class="text-slate-500 dark:text-zinc-400 mt-1">Gerencie adiantamentos e vales de
                                funcionários</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <!-- View Toggle Buttons -->
                            <div class="flex bg-slate-100 dark:bg-zinc-800 p-1 rounded-xl">
                                <button id="advancesGridViewBtn" class="p-2 rounded-lg transition-all"
                                    title="Ver como Cards">
                                    <span class="material-symbols-outlined text-lg block">grid_view</span>
                                </button>
                                <button id="advancesTableViewBtn" class="p-2 rounded-lg transition-all"
                                    title="Ver como Tabela">
                                    <span class="material-symbols-outlined text-lg block">table_rows</span>
                                </button>
                            </div>

                            <div class="flex gap-2">
                                <button id="openFilterAdvancesBtn" onclick="openFilterAdvancesModal()"
                                    class="btn btn-secondary flex-1 md:flex-none flex items-center justify-center gap-2">
                                    <span class="material-symbols-outlined text-lg">filter_list</span>
                                    Filtros
                                </button>
                                <button onclick="openAdvanceModal()" class="btn btn-primary flex items-center gap-2">
                                    <span class="material-symbols-outlined text-lg">add</span>
                                    Novo Adiantamento
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
                        <div class="stat-card from-indigo-500 to-indigo-600">
                            <div class="flex items-center justify-between mb-2">
                                <span class="material-symbols-outlined text-3xl opacity-80">payments</span>
                                <span class="text-xs font-bold bg-white/20 px-2 py-1 rounded">Total</span>
                            </div>
                            <p class="text-sm font-medium opacity-90">Total Adiantado</p>
                            <p class="text-3xl font-black mt-1" id="totalAdvances">R$ 0,00</p>
                        </div>
                        <div class="stat-card from-violet-500 to-violet-600">
                            <div class="flex items-center justify-between mb-2">
                                <span class="material-symbols-outlined text-3xl opacity-80">calendar_month</span>
                                <span class="text-xs font-bold bg-white/20 px-2 py-1 rounded">Mês</span>
                            </div>
                            <p class="text-sm font-medium opacity-90">Referência</p>
                            <p class="text-xl font-black mt-1" id="advancesRefMonth">-</p>
                        </div>
                    </div>

                    <!-- Advances List -->
                    <div id="advancesTableContainer"
                        class="hidden bg-white dark:bg-zinc-900 rounded-xl border border-slate-200 dark:border-zinc-800 overflow-hidden shadow-sm">
                        <div class="p-6 border-b border-slate-200 dark:border-zinc-800">
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white">Histórico de Adiantamentos</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr
                                        class="border-b border-slate-100 dark:border-zinc-800 bg-slate-50/50 dark:bg-zinc-800/50">
                                        <th
                                            class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                            Data</th>
                                        <th
                                            class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                            Funcionário</th>
                                        <th
                                            class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                            Tipo</th>
                                        <th
                                            class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                            Mês Ref.</th>
                                        <th
                                            class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                            Valor</th>
                                        <th
                                            class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider text-right">
                                            Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="advancesTableBody" class="divide-y divide-slate-50 dark:divide-zinc-800/50">
                                    <!-- Advances rows will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Card View Container -->
                    <div id="advancesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <!-- Cards will be injected here -->
                    </div>
                </div>
            </div>

            <div id="clientsView" class="view-content hidden">
                <div class="flex flex-col md:flex-row md:items-end justify-between mb-8 gap-4">
                    <div>
                        <h2 class="text-3xl font-black text-slate-900 dark:text-white tracking-tight">Clientes</h2>
                        <p class="text-slate-500 dark:text-zinc-400 mt-1">Gerencie seus clientes e limites de
                            crédito</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex bg-slate-100 dark:bg-zinc-800 p-1 rounded-xl">
                            <button id="clientGridViewBtn" class="p-2 rounded-lg transition-all" title="Ver como Cards">
                                <span class="material-symbols-outlined text-lg block">grid_view</span>
                            </button>
                            <button id="clientTableViewBtn" class="p-2 rounded-lg transition-all"
                                title="Ver como Tabela">
                                <span class="material-symbols-outlined text-lg block">table_rows</span>
                            </button>
                        </div>
                        <button id="newClientBtn" class="btn btn-primary flex items-center gap-2"
                            onclick="openClientModal()">
                            <span class="material-symbols-outlined text-lg">add</span>
                            Novo Cliente
                        </button>
                    </div>
                </div>

                <!-- Clients Grid -->
                <div id="clientsGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6">
                    <!-- Clients will be loaded here -->
                </div>

                <!-- Clients Table -->
                <div id="clientsTableContainer"
                    class="hidden bg-white dark:bg-zinc-900 rounded-2xl border border-slate-200 dark:border-zinc-800 overflow-hidden shadow-sm">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 dark:bg-zinc-800/50 border-b border-slate-200 dark:border-zinc-800">
                            <tr>
                                <th
                                    class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                    Cliente</th>
                                <th
                                    class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider text-center">
                                    Telefone</th>
                                <th
                                    class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                    Email</th>
                                <th
                                    class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                    Limite</th>
                                <th
                                    class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                    Saldo Devedor</th>
                                <th
                                    class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider text-right">
                                    Ações</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody">
                            <!-- Clients rows will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="clientsEmptyState" class="hidden text-center py-16">
                    <span
                        class="material-symbols-outlined text-6xl text-slate-300 dark:text-zinc-700 mb-4">person_off</span>
                    <h3 class="text-xl font-bold text-slate-700 dark:text-zinc-300 mb-2">Nenhum cliente cadastrado
                    </h3>
                    <p class="text-slate-500 dark:text-zinc-400 mb-6">Comece adicionando seu primeiro cliente</p>
                    <button onclick="openClientModal()" class="btn btn-primary">
                        <span class="material-symbols-outlined text-lg">add</span>
                        Adicionar Cliente
                    </button>
                </div>
            </div>

            <div id="productsView" class="view-content hidden">
                <div class="flex flex-col md:flex-row md:items-end justify-between mb-8 gap-4">
                    <div>
                        <h2 class="text-3xl font-black text-slate-900 dark:text-white tracking-tight">Produtos</h2>
                        <p class="text-slate-500 dark:text-zinc-400 mt-1">Gerencie seu estoque e preços</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <!-- View Toggle Buttons -->
                        <div class="flex bg-slate-100 dark:bg-zinc-800 p-1 rounded-xl">
                            <button id="productGridViewBtn" class="p-2 rounded-lg transition-all"
                                title="Ver como Cards">
                                <span class="material-symbols-outlined text-lg block">grid_view</span>
                            </button>
                            <button id="productTableViewBtn" class="p-2 rounded-lg transition-all"
                                title="Ver como Tabela">
                                <span class="material-symbols-outlined text-lg block">table_rows</span>
                            </button>
                        </div>

                        <button id="newProductBtn" class="btn btn-primary flex items-center gap-2"
                            onclick="openProductModal()">
                            <span class="material-symbols-outlined text-lg">add</span>
                            Novo Produto
                        </button>
                    </div>
                </div>

                <!-- Products Grid -->
                <div id="productsGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6">
                    <!-- Products will be loaded here -->
                </div>

                <!-- Products Table -->
                <div id="productsTableContainer"
                    class="hidden bg-white dark:bg-zinc-900 rounded-2xl border border-slate-200 dark:border-zinc-800 overflow-hidden shadow-sm">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 dark:bg-zinc-800/50 border-b border-slate-200 dark:border-zinc-800">
                            <tr>
                                <th
                                    class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                    Produto</th>
                                <th
                                    class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                    Categoria</th>
                                <th
                                    class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider text-right">
                                    Custo</th>
                                <th
                                    class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider text-right">
                                    Preço Venda</th>
                                <th
                                    class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider text-right">
                                    Ações</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <!-- Products rows will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="productsEmptyState" class="hidden text-center py-16">
                    <span
                        class="material-symbols-outlined text-6xl text-slate-300 dark:text-zinc-700 mb-4">inventory_2</span>
                    <h3 class="text-xl font-bold text-slate-700 dark:text-zinc-300 mb-2">Nenhum produto cadastrado
                    </h3>
                    <p class="text-slate-500 dark:text-zinc-400 mb-6">Comece adicionando seu primeiro produto ao
                        estoque</p>
                    <button onclick="openProductModal()" class="btn btn-primary">
                        <span class="material-symbols-outlined text-lg">add</span>
                        Adicionar Produto
                    </button>
                </div>
            </div>


            <div id="categoriesView" class="view-content hidden">
                <div class="flex flex-col md:flex-row md:items-end justify-between mb-8 gap-4">
                    <div>
                        <h2 class="text-3xl font-black text-slate-900 dark:text-white tracking-tight">Categorias</h2>
                        <p class="text-slate-500 dark:text-zinc-400 mt-1">Organize seus produtos em categorias</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <!-- View Toggle Buttons -->
                        <div class="flex bg-slate-100 dark:bg-zinc-800 p-1 rounded-xl">
                            <button id="categoryGridViewBtn" class="p-2 rounded-lg transition-all"
                                title="Ver como Cards">
                                <span class="material-symbols-outlined text-lg block">grid_view</span>
                            </button>
                            <button id="categoryTableViewBtn" class="p-2 rounded-lg transition-all"
                                title="Ver como Tabela">
                                <span class="material-symbols-outlined text-lg block">table_rows</span>
                            </button>
                        </div>

                        <button id="newCategoryMainBtn" class="btn btn-primary flex items-center gap-2"
                            onclick="openCategoryModal()">
                            <span class="material-symbols-outlined text-lg">add</span>
                            Nova Categoria
                        </button>
                    </div>
                </div>

                <!-- Categories Grid -->
                <div id="categoriesGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6">
                    <!-- Categories will be loaded here -->
                </div>

                <!-- Categories Table -->
                <div id="categoriesTableContainer"
                    class="hidden bg-white dark:bg-zinc-900 rounded-2xl border border-slate-200 dark:border-zinc-800 overflow-hidden shadow-sm">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 dark:bg-zinc-800/50 border-b border-slate-200 dark:border-zinc-800">
                            <tr>
                                <th
                                    class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                    Categoria</th>
                                <th
                                    class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider text-right">
                                    Ações</th>
                            </tr>
                        </thead>
                        <tbody id="categoriesTableBody">
                            <!-- Categories rows will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="categoriesEmptyState" class="hidden text-center py-16">
                    <span
                        class="material-symbols-outlined text-6xl text-slate-300 dark:text-zinc-700 mb-4">category</span>
                    <h3 class="text-xl font-bold text-slate-700 dark:text-zinc-300 mb-2">Nenhuma categoria
                        cadastrada
                    </h3>
                    <p class="text-slate-500 dark:text-zinc-400 mb-6">Comece organizando seus produtos por
                        categorias</p>
                    <button onclick="openCategoryModal()" class="btn btn-primary">
                        <span class="material-symbols-outlined text-lg">add</span>
                        Adicionar Categoria
                    </button>
                </div>
            </div>

            <div id="suppliersView" class="view-content hidden">
                <div class="flex flex-col md:flex-row md:items-end justify-between mb-8 gap-4">
                    <div>
                        <h2 class="text-3xl font-black text-slate-900 dark:text-white tracking-tight">Fornecedores</h2>
                        <p class="text-slate-500 dark:text-zinc-400 mt-1">Gerencie seus parceiros e contatos</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <!-- View Toggle Buttons -->
                        <div class="flex bg-slate-100 dark:bg-zinc-800 p-1 rounded-xl">
                            <button id="supplierGridViewBtn" class="p-2 rounded-lg transition-all"
                                title="Ver como Cards">
                                <span class="material-symbols-outlined text-lg block">grid_view</span>
                            </button>
                            <button id="supplierTableViewBtn" class="p-2 rounded-lg transition-all"
                                title="Ver como Tabela">
                                <span class="material-symbols-outlined text-lg block">table_rows</span>
                            </button>
                        </div>

                        <button id="newSupplierMainBtn" class="btn btn-primary flex items-center gap-2"
                            onclick="openSupplierModal()">
                            <span class="material-symbols-outlined text-lg">add</span>
                            Novo Fornecedor
                        </button>
                    </div>
                </div>

                <!-- Suppliers Grid -->
                <div id="suppliersGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6">
                    <!-- Suppliers will be loaded here -->
                </div>

                <!-- Suppliers Table -->
                <div id="suppliersTableContainer"
                    class="hidden bg-white dark:bg-zinc-900 rounded-2xl border border-slate-200 dark:border-zinc-800 overflow-hidden shadow-sm">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 dark:bg-zinc-800/50 border-b border-slate-200 dark:border-zinc-800">
                            <tr>
                                <th
                                    class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                    Fornecedor</th>
                                <th
                                    class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                    Contato</th>
                                <th
                                    class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                    Telefone</th>
                                <th
                                    class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider text-right">
                                    Ações</th>
                            </tr>
                        </thead>
                        <tbody id="suppliersTableBody">
                            <!-- Suppliers rows will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="suppliersEmptyState" class="hidden text-center py-16">
                    <span
                        class="material-symbols-outlined text-6xl text-slate-300 dark:text-zinc-700 mb-4">local_shipping</span>
                    <h3 class="text-xl font-bold text-slate-700 dark:text-zinc-300 mb-2">Nenhum fornecedor
                        cadastrado
                    </h3>
                    <p class="text-slate-500 dark:text-zinc-400 mb-6">Comece cadastrando seus fornecedores para
                        gerenciar compras e notas</p>
                    <button onclick="openSupplierModal()" class="btn btn-primary">
                        <span class="material-symbols-outlined text-lg">add</span>
                        Adicionar Fornecedor
                    </button>
                </div>
            </div>

            <div id="employeesView" class="view-content hidden">
                <div class="flex flex-col md:flex-row md:items-end justify-between mb-8 gap-4">
                    <div>
                        <h2 class="text-3xl font-black text-slate-900 dark:text-white tracking-tight">Funcionários
                        </h2>
                        <p class="text-slate-500 dark:text-zinc-400 mt-1">Gerencie sua equipe e folha de pagamento
                        </p>
                    </div>
                    <div class="flex items-center gap-4">
                        <!-- View Toggle Buttons -->
                        <div class="flex bg-slate-100 dark:bg-zinc-800 p-1 rounded-xl">
                            <button id="employeeGridViewBtn" class="p-2 rounded-lg transition-all"
                                title="Ver como Cards">
                                <span class="material-symbols-outlined text-lg block">grid_view</span>
                            </button>
                            <button id="employeeTableViewBtn" class="p-2 rounded-lg transition-all"
                                title="Ver como Tabela">
                                <span class="material-symbols-outlined text-lg block">table_rows</span>
                            </button>
                        </div>

                        <button id="newEmployeeMainBtn" class="btn btn-primary flex items-center gap-2"
                            onclick="openEmployeeModal()">
                            <span class="material-symbols-outlined text-lg">add</span>
                            Novo Funcionário
                        </button>
                    </div>
                </div>

                <!-- Employees Grid -->
                <div id="employeesGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6">
                    <!-- Employees will be loaded here -->
                </div>

                <!-- Employees Table -->
                <div id="employeesTableContainer"
                    class="hidden bg-white dark:bg-zinc-900 rounded-2xl border border-slate-200 dark:border-zinc-800 overflow-hidden shadow-sm">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 dark:bg-zinc-800/50 border-b border-slate-200 dark:border-zinc-800">
                            <tr>
                                <th
                                    class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                    Funcionário</th>
                                <th
                                    class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                    Contato</th>
                                <th
                                    class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                    Salário</th>
                                <th
                                    class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider">
                                    Admissão</th>
                                <th
                                    class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase tracking-wider text-right">
                                    Ações</th>
                            </tr>
                        </thead>
                        <tbody id="employeesTableBody">
                            <!-- Employees rows will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="employeesEmptyState" class="hidden text-center py-16">
                    <span class="material-symbols-outlined text-6xl text-slate-300 dark:text-zinc-700 mb-4">badge</span>
                    <h3 class="text-xl font-bold text-slate-700 dark:text-zinc-300 mb-2">Nenhum funcionário
                        cadastrado
                    </h3>
                    <p class="text-slate-500 dark:text-zinc-400 mb-6">Comece cadastrando sua equipe para gerenciar
                        adiantamentos e pagamentos</p>
                    <button onclick="openEmployeeModal()" class="btn btn-primary">
                        <span class="material-symbols-outlined text-lg">add</span>
                        Adicionar Funcionário
                    </button>
                </div>
            </div>
    </div>

    <!-- Pagination Footer -->
    <div id="paginationFooter"
        class="absolute bottom-0 left-0 right-0 h-16 bg-white dark:bg-zinc-900 border-t border-slate-200 dark:border-zinc-800 flex items-center justify-center px-8 z-30 shadow-lg transition-transform translate-y-full">
        <div class="max-w-7xl w-full flex items-center justify-between">
            <div id="paginationInfo" class="text-sm font-medium text-slate-500 dark:text-zinc-400">
                Página <span class="text-slate-900 dark:text-white font-bold" id="currentPageDisplay">1</span>
                de <span class="text-slate-900 dark:text-white font-bold" id="totalPagesDisplay">1</span>
            </div>
            <div class="flex items-center gap-2">
                <button id="prevPageBtn"
                    class="flex items-center gap-2 px-4 py-2 text-sm font-bold text-slate-400 cursor-not-allowed bg-slate-50 dark:bg-zinc-800 rounded-lg border border-slate-200 dark:border-zinc-800 transition-all opacity-60"
                    disabled>
                    <span class="material-symbols-outlined text-lg">chevron_left</span>
                    Anterior
                </button>
                <div id="pageNumbersContainer" class="flex items-center gap-1.5 px-2">
                    <!-- Page numbers will be rendered here -->
                </div>
                <button id="nextPageBtn"
                    class="flex items-center gap-2 px-4 py-2 text-sm font-bold text-primary-600 hover:text-white bg-white dark:bg-zinc-900 hover:bg-primary-600 rounded-lg border border-primary-600/20 hover:border-primary-600 transition-all shadow-sm">
                    Próximo
                    <span class="material-symbols-outlined text-lg">chevron_right</span>
                </button>
            </div>
            <div class="flex items-center gap-2 text-sm font-medium text-slate-500 dark:text-zinc-400">
                <span>Ver</span>
                <div class="relative">
                    <select id="itemsPerPageSelect"
                        class="bg-slate-50 dark:bg-zinc-800 border-none rounded-md py-1 pl-3 pr-8 text-sm focus:ring-1 focus:ring-primary/20 text-slate-900 dark:text-white font-bold cursor-pointer">
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    </main>
    </div>

    <!-- Client Modal -->
    <div id="clientModal" class="modal hidden">
        <div class="modal-content max-w-2xl">
            <div class="p-6 border-b border-slate-200 dark:border-zinc-800">
                <h3 class="text-2xl font-bold text-slate-900 dark:text-white" id="clientModalTitle">Novo Cliente</h3>
            </div>
            <form id="clientForm" class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group md:col-span-2">
                        <label class="form-label">Nome *</label>
                        <input type="text" id="clientName" class="form-input" placeholder="Nome completo" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telefone</label>
                        <input type="tel" id="clientPhone" class="form-input" placeholder="(00) 00000-0000" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="clientEmail" class="form-input" placeholder="email@exemplo.com" />
                    </div>
                    <div class="form-group md:col-span-2">
                        <label class="form-label">Limite de Crédito (R$)</label>
                        <input type="number" id="clientCreditLimit" class="form-input" placeholder="0.00" step="0.01"
                            min="0" />
                    </div>
                </div>
                <input type="hidden" id="clientId" />
                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closeClientModal()"
                        class="btn btn-secondary flex-1">Cancelar</button>
                    <button type="submit" class="btn btn-primary flex-1">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal hidden">
        <div class="modal-content max-w-2xl">
            <div class="p-6 border-b border-slate-200 dark:border-zinc-800">
                <div class="flex items-center justify-between">
                    <h3 id="productModalTitle"
                        class="text-2xl font-black text-slate-900 dark:text-white tracking-tight">Novo Produto</h3>
                    <button onclick="closeProductModal()"
                        class="text-slate-400 hover:text-slate-600 dark:hover:text-white transition-colors">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
            </div>
            <form id="productForm" class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group md:col-span-2">
                        <label class="form-label">Nome do Produto</label>
                        <input type="text" id="productName" class="form-input" placeholder="Ex: Cerveja Artesanal 500ml"
                            required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Categoria</label>
                        <div class="flex gap-2">
                            <select id="productCategory" class="form-input">
                                <option value="">Sem Categoria</option>
                            </select>
                            <button type="button" onclick="openCategoryModal()" class="btn btn-secondary px-3"
                                title="Nova Categoria">
                                <span class="material-symbols-outlined text-lg">add</span>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Preço de Custo (R$)</label>
                        <input type="number" id="productCostPrice" class="form-input" placeholder="0.00" step="0.01"
                            min="0" />
                    </div>
                    <div class="form-group md:col-span-2">
                        <label class="form-label">Preço de Venda (R$)</label>
                        <input type="number" id="productSalePrice" class="form-input" placeholder="0.00" step="0.01"
                            min="0.01" required />
                    </div>
                </div>
                <input type="hidden" id="productId" />
                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closeProductModal()"
                        class="btn btn-secondary flex-1">Cancelar</button>
                    <button type="submit" class="btn btn-primary flex-1">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Product Confirmation Modal -->
    <div id="deleteProductModal" class="modal hidden">
        <div class="modal-content max-w-md">
            <div class="p-6">
                <div class="flex items-center gap-4 mb-4">
                    <div class="size-12 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
                        <span class="material-symbols-outlined text-red-600 dark:text-red-400 text-2xl">warning</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-slate-900 dark:text-white">Excluir Produto</h3>
                        <p class="text-sm text-slate-500 dark:text-zinc-400">Esta ação não pode ser desfeita</p>
                    </div>
                </div>
                <p class="text-slate-600 dark:text-zinc-400 mb-6">Tem certeza que deseja excluir o produto <strong
                        id="deleteProductName"></strong>?</p>
                <div class="flex gap-3">
                    <button type="button" onclick="closeDeleteProductModal()"
                        class="btn btn-secondary flex-1">Cancelar</button>
                    <button type="button" id="confirmDeleteProductBtn" class="btn btn-danger flex-1">Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="categoryModal" class="modal hidden">
        <div class="modal-content max-w-sm">
            <div class="p-6 border-b border-slate-200 dark:border-zinc-800">
                <div class="flex items-center justify-between">
                    <h3 id="categoryModalTitle" class="text-xl font-bold text-slate-900 dark:text-white">Nova Categoria
                    </h3>
                    <button onclick="closeCategoryModal()"
                        class="text-slate-400 hover:text-slate-600 dark:hover:text-white transition-colors">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
            </div>
            <form id="categoryForm" class="p-6">
                <div class="form-group">
                    <label class="form-label">Nome da Categoria</label>
                    <input type="text" id="categoryName" class="form-input" placeholder="Ex: Bebidas" required />
                </div>
                <input type="hidden" id="categoryId" />
                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closeCategoryModal()"
                        class="btn btn-secondary flex-1">Cancelar</button>
                    <button type="submit" class="btn btn-primary flex-1">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Category Confirmation Modal -->
    <div id="deleteCategoryModal" class="modal hidden">
        <div class="modal-content max-w-md">
            <div class="p-6">
                <div class="flex items-center gap-4 mb-4">
                    <div class="size-12 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
                        <span class="material-symbols-outlined text-red-600 dark:text-red-400 text-2xl">warning</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-slate-900 dark:text-white">Excluir Categoria</h3>
                        <p class="text-sm text-slate-500 dark:text-zinc-400">Esta ação não pode ser desfeita</p>
                    </div>
                </div>
                <p class="text-slate-600 dark:text-zinc-400 mb-6">Tem certeza que deseja excluir a categoria <strong
                        id="deleteCategoryName"></strong>? Isso pode afetar produtos vinculados.</p>
                <div class="flex gap-3">
                    <button type="button" onclick="closeDeleteCategoryModal()"
                        class="btn btn-secondary flex-1">Cancelar</button>
                    <button type="button" id="confirmDeleteCategoryBtn" class="btn btn-danger flex-1">Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Supplier Modal -->
    <div id="supplierModal" class="modal hidden">
        <div class="modal-content max-w-lg">
            <div class="p-6 border-b border-slate-200 dark:border-zinc-800">
                <div class="flex items-center justify-between">
                    <h3 id="supplierModalTitle" class="text-xl font-bold text-slate-900 dark:text-white">Novo Fornecedor
                    </h3>
                    <button onclick="closeSupplierModal()"
                        class="text-slate-400 hover:text-slate-600 dark:hover:text-white transition-colors">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
            </div>
            <form id="supplierForm" class="p-6">
                <input type="hidden" id="supplierId" />
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group md:col-span-2">
                        <label class="form-label">Nome da Empresa / Razão Social</label>
                        <input type="text" id="supplierName" class="form-input" placeholder="Ex: Distribuidora Silva"
                            required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contato / Vendedor</label>
                        <input type="text" id="supplierContact" class="form-input" placeholder="Ex: Maria Pereira" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telefone</label>
                        <input type="tel" id="supplierPhone" class="form-input" placeholder="(00) 00000-0000" />
                    </div>
                </div>
                <div class="flex gap-3 mt-8">
                    <button type="button" onclick="closeSupplierModal()"
                        class="btn btn-secondary flex-1">Cancelar</button>
                    <button type="submit" class="btn btn-primary flex-1">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Supplier Confirmation Modal -->
    <div id="deleteSupplierModal" class="modal hidden">
        <div class="modal-content max-w-md">
            <div class="p-6">
                <div class="flex items-center gap-4 mb-4">
                    <div class="size-12 rounded-full bg-red-100 dark:bg-red-900/20 flex items-center justify-center">
                        <span class="material-symbols-outlined text-red-600 dark:text-red-400 text-2xl">warning</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-slate-900 dark:text-white">Excluir Fornecedor</h3>
                        <p class="text-sm text-slate-500 dark:text-zinc-400">Esta ação não pode ser desfeita</p>
                    </div>
                </div>
                <p class="text-slate-600 dark:text-zinc-400 mb-6">Tem certeza que deseja excluir o fornecedor <strong
                        id="deleteSupplierName"></strong>?</p>
                <div class="flex gap-3">
                    <button type="button" onclick="closeDeleteSupplierModal()"
                        class="btn btn-secondary flex-1">Cancelar</button>
                    <button type="button" id="confirmDeleteSupplierBtn" class="btn btn-danger flex-1">Excluir</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Employee Modal -->
    <div id="employeeModal" class="modal hidden">
        <div class="modal-content max-w-lg">
            <div class="p-6 border-b border-slate-200 dark:border-zinc-800">
                <div class="flex items-center justify-between">
                    <h3 id="employeeModalTitle" class="text-xl font-bold text-slate-900 dark:text-white">Novo
                        Funcionário</h3>
                    <button onclick="closeEmployeeModal()"
                        class="text-slate-400 hover:text-slate-600 dark:hover:text-white transition-colors">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
            </div>
            <form id="employeeForm" class="p-6">
                <input type="hidden" id="employeeId" />
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group md:col-span-2">
                        <label class="form-label">Nome Completo</label>
                        <input type="text" id="employeeName" class="form-input" placeholder="Ex: João Silva" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telefone</label>
                        <input type="text" id="employeePhone" class="form-input" placeholder="(00) 00000-0000" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Salário (R$)</label>
                        <input type="number" step="0.01" id="employeeSalary" class="form-input" placeholder="0.00"
                            required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data de Admissão</label>
                        <input type="date" id="employeeAdmissionDate" class="form-input" />
                    </div>
                </div>
                <div class="flex gap-3 mt-8">
                    <button type="button" onclick="closeEmployeeModal()"
                        class="btn btn-secondary flex-1">Cancelar</button>
                    <button type="submit" class="btn btn-primary flex-1">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Employee Confirmation Modal -->
    <div id="deleteEmployeeModal" class="modal hidden">
        <div class="modal-content max-w-md">
            <div class="p-6">
                <div class="flex items-center gap-4 mb-4">
                    <div class="size-12 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
                        <span class="material-symbols-outlined text-red-600 dark:text-red-400 text-2xl">warning</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-slate-900 dark:text-white">Excluir Funcionário</h3>
                        <p class="text-sm text-slate-500 dark:text-zinc-400">Esta ação não pode ser desfeita</p>
                    </div>
                </div>
                <p class="text-slate-600 dark:text-zinc-400 mb-6">Tem certeza que deseja excluir o funcionário <strong
                        id="deleteEmployeeName"></strong>?</p>
                <div class="flex gap-3">
                    <button type="button" onclick="closeDeleteEmployeeModal()"
                        class="btn btn-secondary flex-1">Cancelar</button>
                    <button type="button" id="confirmDeleteEmployeeBtn" class="btn btn-danger flex-1">Excluir</button>
                </div>
            </div>
        </div>
    </div>
    <div id="deleteClientModal" class="modal hidden">
        <div class="modal-content max-w-md">
            <div class="p-6">
                <div class="flex items-center gap-4 mb-4">
                    <div class="size-12 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
                        <span class="material-symbols-outlined text-red-600 dark:text-red-400 text-2xl">warning</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-slate-900 dark:text-white">Excluir Cliente</h3>
                        <p class="text-sm text-slate-500 dark:text-zinc-400">Esta ação não pode ser desfeita</p>
                    </div>
                </div>
                <p class="text-slate-600 dark:text-zinc-400 mb-6">Tem certeza que deseja excluir o cliente <strong
                        id="deleteClientName"></strong>?</p>
                <div class="flex gap-3">
                    <button type="button" onclick="closeDeleteClientModal()"
                        class="btn btn-secondary flex-1">Cancelar</button>
                    <button type="button" onclick="confirmDeleteClient()" class="btn btn-danger flex-1">Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Sale Modal -->
    <div id="viewSaleModal" class="modal hidden">
        <div class="modal-content max-w-5xl">
            <div class="p-6 border-b border-slate-200 dark:border-zinc-800 flex justify-between items-center">
                <div>
                    <h3 class="text-2xl font-black text-slate-900 dark:text-white tracking-tight" id="viewSaleTitle">
                        Detalhes da Venda</h3>
                    <p class="text-sm text-slate-500 dark:text-zinc-400" id="viewSaleDate">-</p>
                </div>
                <button onclick="closeViewSaleModal()"
                    class="text-slate-400 hover:text-slate-600 dark:hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="flex flex-col lg:flex-row min-h-[500px]">
                <!-- Main Sale Info -->
                <div class="flex-1 p-6 border-b lg:border-b-0 lg:border-r border-slate-100 dark:border-zinc-800">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-slate-50 dark:bg-zinc-800/50 p-4 rounded-xl">
                            <span class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Cliente</span>
                            <p class="text-sm font-bold text-slate-900 dark:text-white" id="viewSaleClient">-</p>
                        </div>
                        <div class="bg-slate-50 dark:bg-zinc-800/50 p-4 rounded-xl">
                            <span class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Pagamento
                                (Base)</span>
                            <p class="text-sm font-bold text-slate-900 dark:text-white" id="viewSalePayment">-</p>
                        </div>
                        <div class="bg-slate-50 dark:bg-zinc-800/50 p-4 rounded-xl">
                            <span class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Total da
                                Venda</span>
                            <p class="text-xl font-black text-primary" id="viewSaleTotal">R$ 0,00</p>
                        </div>
                    </div>

                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Itens do Pedido</h4>
                    <div class="border border-slate-100 dark:border-zinc-800 rounded-xl overflow-hidden">
                        <table class="w-full text-left border-collapse">
                            <thead
                                class="bg-slate-50 dark:bg-zinc-800/50 text-[10px] font-bold text-slate-500 uppercase tracking-wider border-b border-slate-100 dark:border-zinc-800">
                                <tr>
                                    <th class="px-6 py-3">Produto</th>
                                    <th class="px-6 py-3 text-center">Qtde</th>
                                    <th class="px-6 py-3 text-right">Preço</th>
                                    <th class="px-6 py-3 text-right">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody id="viewSaleItemsBody" class="divide-y divide-slate-100 dark:divide-zinc-800">
                                <!-- Items will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Payments Section -->
                <div class="w-full lg:w-96 bg-slate-50/50 dark:bg-zinc-900/50 p-6 flex flex-col">
                    <div class="flex items-center justify-between mb-6">
                        <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Histórico de Recebimentos
                        </h4>
                        <div id="viewSaleBalance" class="text-right">
                            <span class="text-[10px] font-bold text-slate-400 uppercase block">Saldo Restante</span>
                            <p class="text-base font-black text-rose-500" id="viewSaleDebt">R$ 0,00</p>
                        </div>
                    </div>

                    <div id="paymentsHistoryList" class="flex-1 space-y-3 overflow-y-auto mb-6 max-h-[300px] pr-2">
                        <!-- Payments will be loaded here -->
                    </div>

                    <!-- Add Payment Form (Hidden if Sale is Pago) -->
                    <div id="addPaymentSection" class="pt-6 border-t border-slate-200 dark:border-zinc-800">
                        <h5 class="text-sm font-bold text-slate-900 dark:text-white mb-4">Registrar Pagamento</h5>
                        <form id="addSalePaymentForm" class="space-y-3">
                            <input type="hidden" id="addPaymentSaleId" />
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label
                                        class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Valor</label>
                                    <input type="number" step="0.01" id="addPaymentValue"
                                        class="form-input text-sm py-2" required placeholder="0.00" />
                                </div>
                                <div>
                                    <label
                                        class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Meio</label>
                                    <select id="addPaymentMethod" class="form-input text-sm py-2" required>
                                        <option value="Dinheiro">Dinheiro</option>
                                        <option value="Pix">Pix</option>
                                        <option value="Cartão Débito">Débito</option>
                                        <option value="Cartão Crédito">Crédito</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit"
                                class="btn btn-primary w-full text-xs py-2 font-bold flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined text-sm">payments</span>
                                Confirmar Recebimento
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-200 dark:border-zinc-800 flex justify-end gap-3">
                <button onclick="closeViewSaleModal()" class="btn btn-secondary">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Filter Sales Modal -->
    <div id="filterSalesModal" class="modal hidden">
        <div class="modal-content max-w-lg">
            <div class="p-6 border-b border-slate-200 dark:border-zinc-800 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-900 dark:text-white">Filtrar Vendas</h3>
                <button onclick="closeFilterModal()"
                    class="text-slate-400 hover:text-slate-600 dark:hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label text-xs uppercase tracking-wider font-bold opacity-60">Data
                            Inicial</label>
                        <input type="date" id="filterStartDate" class="form-input" />
                    </div>
                    <div class="form-group">
                        <label class="form-label text-xs uppercase tracking-wider font-bold opacity-60">Data
                            Final</label>
                        <input type="date" id="filterEndDate" class="form-input" />
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label text-xs uppercase tracking-wider font-bold opacity-60">Status do
                        Pagamento</label>
                    <select id="filterStatus" class="form-input">
                        <option value="">Todos os Status</option>
                        <option value="Pago">Pago</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Parcial">Parcial</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label text-xs uppercase tracking-wider font-bold opacity-60">Forma de
                        Pagamento</label>
                    <select id="filterPaymentMethod" class="form-input">
                        <option value="">Todas as Formas</option>
                        <option value="Dinheiro">Dinheiro</option>
                        <option value="Pix">Pix</option>
                        <option value="Cartão Débito">Cartão Débito</option>
                        <option value="Cartão Crédito">Cartão Crédito</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label text-xs uppercase tracking-wider font-bold opacity-60">Cliente</label>
                    <select id="filterClient" class="form-input">
                        <option value="">Todos os Clientes</option>
                        <!-- Clients will be loaded here -->
                    </select>
                </div>
            </div>
            <div class="p-6 border-t border-slate-200 dark:border-zinc-800 flex gap-3">
                <button onclick="clearFilters()" class="btn btn-secondary flex-1">Limpar</button>
                <button onclick="applyFilters()" class="btn btn-primary flex-1">Aplicar Filtros</button>
            </div>
        </div>
    </div>

    <!-- Filter Payables Modal -->
    <div id="filterPayablesModal" class="modal hidden">
        <div class="modal-content max-w-lg">
            <div class="p-6 border-b border-slate-200 dark:border-zinc-800 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-900 dark:text-white">Filtrar Contas a Pagar</h3>
                <button onclick="closeFilterPayablesModal()"
                    class="text-slate-400 hover:text-slate-600 dark:hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label text-xs uppercase tracking-wider font-bold opacity-60">Vencimento
                            Inicial</label>
                        <input type="date" id="filterPayableStartDate" class="form-input" />
                    </div>
                    <div class="form-group">
                        <label class="form-label text-xs uppercase tracking-wider font-bold opacity-60">Vencimento
                            Final</label>
                        <input type="date" id="filterPayableEndDate" class="form-input" />
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label text-xs uppercase tracking-wider font-bold opacity-60">Status</label>
                    <select id="filterPayableStatus" class="form-input">
                        <option value="">Todos os Status</option>
                        <option value="A Vencer">A Vencer</option>
                        <option value="Pago">Pago</option>
                        <option value="Vencido">Vencido</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label text-xs uppercase tracking-wider font-bold opacity-60">Fornecedor</label>
                    <select id="filterPayableSupplier" class="form-input">
                        <option value="">Todos os Fornecedores</option>
                    </select>
                </div>
            </div>
            <div class="p-6 border-t border-slate-200 dark:border-zinc-800 flex gap-3">
                <button onclick="clearPayableFilters()" class="btn btn-secondary flex-1">Limpar</button>
                <button onclick="applyPayableFilters()" class="btn btn-primary flex-1">Aplicar Filtros</button>
            </div>
        </div>
    </div>

    <!-- Payable Form Modal -->
    <div id="payableModal" class="modal hidden">
        <div class="modal-content max-w-2xl">
            <div class="p-6 border-b border-slate-200 dark:border-zinc-800 flex justify-between items-center">
                <h3 class="text-2xl font-black text-slate-900 dark:text-white tracking-tight" id="payableModalTitle">
                    Nova Conta a Pagar</h3>
                <button onclick="closePayableModal()"
                    class="text-slate-400 hover:text-slate-600 dark:hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <form id="payableForm" class="p-6 space-y-4">
                <input type="hidden" id="payableId" />
                <div class="form-group">
                    <label class="form-label">Fornecedor *</label>
                    <select id="payableSupplier" class="form-input" required>
                        <option value="">Selecione um fornecedor</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Número da Nota/Doc</label>
                        <input type="text" id="payableInvoiceNumber" class="form-input" placeholder="Ex: NF-123" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data de Vencimento *</label>
                        <input type="date" id="payableDueDate" class="form-input" required />
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Valor Total (R$) *</label>
                        <input type="number" step="0.01" id="payableTotalValue" class="form-input" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status *</label>
                        <select id="payableStatus" class="form-input" required>
                            <option value="A Vencer">A Vencer</option>
                            <option value="Pago">Pago</option>
                            <option value="Vencido">Vencido</option>
                        </select>
                    </div>
                </div>

                <div class="flex gap-3 mt-8">
                    <button type="button" onclick="closePayableModal()"
                        class="btn btn-secondary flex-1">Cancelar</button>
                    <button type="submit" class="btn btn-primary flex-1">Salvar Conta</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Batch Payment Modal -->
    <div id="batchPaymentModal" class="modal hidden">
        <div class="modal-content max-w-lg">
            <div class="p-6 border-b border-slate-200 dark:border-zinc-800 flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-black text-slate-900 dark:text-white tracking-tight">Recebimento em Lote
                    </h3>
                    <p class="text-xs text-slate-500 dark:text-zinc-400" id="batchPaymentClientName">-</p>
                </div>
                <button onclick="closeBatchPaymentModal()"
                    class="text-slate-400 hover:text-slate-600 dark:hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <form id="batchPaymentForm" class="p-6 space-y-4">
                <input type="hidden" id="batchPaymentClientId" />

                <div class="bg-primary/5 p-4 rounded-xl border border-primary/10 mb-4">
                    <p class="text-xs text-primary-700 dark:text-primary-400 leading-relaxed font-medium">
                        O valor informado será abatido automaticamente das notas mais antigas para as mais novas (FIFO).
                    </p>
                </div>

                <div
                    class="flex items-center justify-between p-4 bg-rose-50 dark:bg-rose-900/10 rounded-xl border border-rose-100 dark:border-rose-900/20 mb-6">
                    <span class="text-xs font-bold text-rose-600 dark:text-rose-400 uppercase">Saldo Devedor
                        Atual</span>
                    <span class="text-xl font-black text-rose-600 dark:text-rose-400" id="batchPaymentDebt">R$
                        0,00</span>
                </div>

                <div class="form-group">
                    <label class="form-label">Valor Recebido (R$)</label>
                    <input type="number" step="0.01" id="batchPaymentValue" class="form-input text-lg font-bold"
                        required placeholder="0.00" />
                </div>

                <div class="form-group">
                    <label class="form-label">Forma de Pagamento</label>
                    <select id="batchPaymentMethod" class="form-input" required>
                        <option value="Dinheiro">Dinheiro</option>
                        <option value="Pix">Pix</option>
                        <option value="Cartão Débito">Cartão Débito</option>
                        <option value="Cartão Crédito">Cartão Crédito</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Observação (Opcional)</label>
                    <input type="text" id="batchPaymentObs" class="form-input"
                        placeholder="Ex: Pagamento parcial de conta corrente" />
                </div>

                <div class="flex gap-3 mt-8">
                    <button type="button" onclick="closeBatchPaymentModal()"
                        class="btn btn-secondary flex-1">Cancelar</button>
                    <button type="submit" class="btn btn-primary flex-1">Confirmar Recebimento</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Advance Modal -->
    <div id="advanceModal" class="modal hidden">
        <div class="modal-content max-w-md">
            <div class="p-6 border-b border-slate-200 dark:border-zinc-800 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-900 dark:text-white" id="advanceModalTitle">Novo Adiantamento
                </h3>
                <button onclick="closeAdvanceModal()"
                    class="text-slate-400 hover:text-slate-600 dark:hover:text-zinc-200 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <form id="advanceForm" class="p-6 space-y-4">
                <input type="hidden" id="advanceId">

                <div class="form-group">
                    <label class="form-label">Funcionário</label>
                    <div class="relative">
                        <select id="advanceEmployee" class="form-input appearance-none" required>
                            <!-- Options loaded via JS -->
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Tipo</label>
                    <select id="advanceType" class="form-input">
                        <option value="Adiantamento">Adiantamento Salarial</option>
                        <option value="Vale">Vale Transporte/Refeição</option>
                        <option value="Bônus">Bônus/Gratificação</option>
                        <option value="Salário">Salário Mensal</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Valor (R$)</label>
                        <input type="number" step="0.01" id="advanceValue" class="form-input" placeholder="0.00"
                            required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mês Referência</label>
                        <input type="month" id="advanceRefMonth" class="form-input" required>
                    </div>
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeAdvanceModal()"
                        class="btn btn-secondary flex-1">Cancelar</button>
                    <button type="submit" class="btn btn-primary flex-1">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Filter Advances Modal -->
    <div id="filterAdvancesModal" class="modal hidden">
        <div class="modal-content max-w-md">
            <div class="p-6 border-b border-slate-200 dark:border-zinc-800 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-900 dark:text-white">Filtrar Adiantamentos</h3>
                <button onclick="closeFilterAdvancesModal()"
                    class="text-slate-400 hover:text-slate-600 dark:hover:text-zinc-200 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">De</label>
                        <input type="date" id="filterAdvanceStartDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Até</label>
                        <input type="date" id="filterAdvanceEndDate" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Funcionário</label>
                    <select id="filterAdvanceEmployee" class="form-input">
                        <!-- Loaded via JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo</label>
                    <select id="filterAdvanceType" class="form-input">
                        <option value="">Todos</option>
                        <option value="Adiantamento">Adiantamento Salarial</option>
                        <option value="Vale">Vale Transporte/Refeição</option>
                        <option value="Salário">Salário Mensal</option>
                        <option value="Bônus">Bônus/Gratificação</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
                <div class="pt-4 flex gap-3">
                    <button onclick="clearAdvanceFilters()" class="btn btn-secondary flex-1">Limpar</button>
                    <button onclick="applyAdvanceFilters()" class="btn btn-primary flex-1">Aplicar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Advance Modal -->
    <div id="deleteAdvanceModal" class="modal hidden">
        <div class="modal-content max-w-md">
            <div class="p-6">
                <div class="flex items-center gap-4 mb-4">
                    <div class="size-12 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
                        <span class="material-symbols-outlined text-red-600 dark:text-red-400 text-2xl">warning</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-slate-900 dark:text-white">Excluir Adiantamento</h3>
                        <p class="text-sm text-slate-500 dark:text-zinc-400">Esta ação não pode ser desfeita</p>
                    </div>
                </div>
                <p class="text-slate-600 dark:text-zinc-400 mb-6">Confirma a exclusão deste lançamento?</p>
                <div class="flex gap-3">
                    <button type="button" onclick="closeDeleteAdvanceModal()"
                        class="btn btn-secondary flex-1">Cancelar</button>
                    <button type="button" id="confirmDeleteAdvanceBtn" class="btn btn-danger flex-1">Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State Management
        const state = {
            token: null,
            user: null,
            sales: [],
            clients: [],
            products: [],
            categories: [],
            employees: [],
            suppliers: [],
            advances: [],
            currentView: 'receivables',
            clientViewMode: 'grid', // 'grid' or 'table'
            salesViewMode: 'grid', // Changed from 'table' to 'grid'
            productViewMode: 'grid', // 'grid' or 'table'
            categoryViewMode: 'grid', // 'grid' or 'table'
            employeeViewMode: 'grid', // 'grid' or 'table'
            supplierViewMode: 'grid', // 'grid' or 'table'
            currentSale: {
                id_cliente: null,
                itens: [],
                forma_pagamento: 'Dinheiro',
                status_pagamento: 'Pago',
                valor_total: 0
            },
            searchQuery: '',
            filters: {
                sales: {
                    startDate: '',
                    endDate: '',
                    status: '',
                    paymentMethod: '',
                    clientId: ''
                },
                payables: {
                    startDate: '',
                    endDate: '',
                    status: '',
                    supplierId: ''
                },
                advances: {
                    startDate: '',
                    endDate: '',
                    type: '',
                    employeeId: ''
                }
            },
            payables: [],
            payablesViewMode: 'grid',
            advancesViewMode: 'grid',
            pagination: {
                clients: { currentPage: 1, itemsPerPage: 10, totalItems: 0 },
                products: { currentPage: 1, itemsPerPage: 10, totalItems: 0 },
                categories: { currentPage: 1, itemsPerPage: 10, totalItems: 0 },
                employees: { currentPage: 1, itemsPerPage: 10, totalItems: 0 },
                suppliers: { currentPage: 1, itemsPerPage: 10, totalItems: 0 },
                receivables: { currentPage: 1, itemsPerPage: 10, totalItems: 0 },
                payables: { currentPage: 1, itemsPerPage: 10, totalItems: 0 },
                advances: { currentPage: 1, itemsPerPage: 10, totalItems: 0 }
            }
        };

        // API Base URL
        const API_URL = window.location.origin;

        // Utility Functions
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value || 0);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return new Intl.DateTimeFormat('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }).format(date);
        }

        function formatSimpleDate(dateString) {
            if (!dateString) return '-';
            if (typeof dateString !== 'string') dateString = String(dateString);
            // Se já tiver T ou espaço, assume que já tem hora e não concatena T00:00:00
            const hasTime = dateString.includes('T') || dateString.includes(' ');
            const date = new Date(hasTime ? dateString : dateString + 'T00:00:00');
            return new Intl.DateTimeFormat('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            }).format(date);
        }

        function getStatusClass(status) {
            const statusMap = {
                'Pendente': 'status-pendente',
                'Pago': 'status-pago',
                'Parcial': 'status-parcial',
                'Atrasado': 'status-atrasado'
            };
            return statusMap[status] || 'status-pendente';
        }

        function getPaymentMethodLabel(method) {
            const methodMap = {
                'Dinheiro': 'Dinheiro',
                'Cartão Débito': 'Débito',
                'Cartão Crédito': 'Crédito',
                'Pix': 'PIX'
            };
            return methodMap[method] || method;
        }

        function getAdvanceTypeLabel(type) {
            const map = {
                'Adiantamento': 'Adiantamento Salarial',
                'Vale': 'Vale Transporte/Refeição',
                'Salário': 'Salário Mensal',
                'Bônus': 'Bônus/Gratificação'
            };
            return map[type] || type;
        }

        function getAdvanceTypeClass(type) {
            const label = getAdvanceTypeLabel(type);
            switch (label) {
                case 'Adiantamento Salarial':
                    return 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400 border-amber-200/50 dark:border-amber-800/50';
                case 'Vale Transporte/Refeição':
                    return 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400 border-emerald-200/50 dark:border-emerald-800/50';
                case 'Salário Mensal':
                    return 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400 border-blue-200/50 dark:border-blue-800/50';
                case 'Bônus/Gratificação':
                    return 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400 border-purple-200/50 dark:border-purple-800/50';
                default:
                    return 'bg-slate-100 text-slate-700 dark:bg-zinc-800 dark:text-zinc-400 border-slate-200 dark:border-zinc-700';
            }
        }

        // API Functions
        async function apiRequest(endpoint, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };

            if (state.token) {
                headers['Authorization'] = `Bearer ${state.token}`;
            }

            try {
                console.log(`Realizando fetch: ${API_URL}${endpoint}`, options);
                const response = await fetch(`${API_URL}${endpoint}`, {
                    ...options,
                    headers
                });
                console.log(`Resposta básica: ${response.status} ${response.statusText}`);

                if (!response.ok) {
                    if (response.status === 401) {
                        logout();
                        throw new Error('Sessão expirada. Faça login novamente.');
                    }
                    throw new Error(`Erro na requisição: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        async function login(email, password) {
            const formData = new URLSearchParams();
            formData.append('username', email);
            formData.append('password', password);

            const response = await fetch(`${API_URL}/login/access-token`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData
            });

            if (!response.ok) {
                throw new Error('Email ou senha incorretos');
            }

            const data = await response.json();
            state.token = data.access_token;
            localStorage.setItem('token', data.access_token);
            return data;
        }

        async function loadSales() {
            try {
                const sales = await apiRequest('/sales/');
                state.sales = sales;
                renderSales();
                updateStats();
            } catch (error) {
                console.error('Error loading sales:', error);
            }
        }

        async function loadClients() {
            try {
                const clients = await apiRequest('/clients/');
                state.clients = clients;
                state.pagination.clients.totalItems = clients.length;

                // Keep current page if possible, otherwise reset to 1
                const maxPage = Math.ceil(state.clients.length / state.pagination.clients.itemsPerPage) || 1;
                if (state.pagination.clients.currentPage > maxPage) {
                    state.pagination.clients.currentPage = maxPage;
                }

                renderClients();
                updatePaginationFooter();
            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }

        // Product Management Functions
        async function loadProducts() {
            try {
                const response = await apiRequest('/products/');
                if (response) {
                    state.products = response;
                    renderProducts();
                }
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
            }
        }

        async function loadCategories() {
            try {
                const response = await apiRequest('/products/categories/');
                if (response) {
                    state.categories = response;
                    state.pagination.categories.totalItems = response.length;
                    updateCategorySelects();
                    if (state.currentView === 'categories') {
                        renderCategories();
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
            }
        }

        // Sale Management Functions
        function initNewSale() {
            state.currentSale = {
                id_cliente: null,
                itens: [],
                forma_pagamento: 'Dinheiro',
                status_pagamento: 'Pago',
                valor_total: 0
            };
            document.getElementById('saleProductSearch').value = '';
            document.getElementById('saleClientSelect').value = '';
            document.getElementById('salePaymentMethod').value = 'Dinheiro';
            document.getElementById('salePaymentStatus').value = 'Pago';
            document.getElementById('saleDownPaymentGroup').classList.add('hidden');
            document.getElementById('saleDownPayment').value = '';

            const btn = document.getElementById('finishSaleBtn');
            if (btn) btn.innerHTML = '<span class="material-symbols-outlined">check_circle</span> Finalizar Venda';

            updateSaleClientSelect();
            renderSaleItems();
        }

        function updateSaleClientSelect() {
            const select = document.getElementById('saleClientSelect');
            if (select) {
                const defaultClient = state.clients.find(c => c.nome === "Consumidor Final");
                const defaultId = defaultClient ? defaultClient.id_cliente : "";

                const options = state.clients
                    .filter(c => c.nome !== "Consumidor Final") // Don't show it twice
                    .map(client => `
                        <option value="${client.id_cliente}">${client.nome}</option>
                    `).join('');

                select.innerHTML = `<option value="${defaultId}">Consumidor Final (Balcão)</option>` + options;

                // If initializing a new sale, automatically set this value in the state
                if (state.currentSale && !state.currentSale.id_vendas && !state.currentSale.id_cliente) {
                    state.currentSale.id_cliente = defaultId;
                }
            }
        }

        function renderSaleItems() {
            const body = document.getElementById('saleItemsBody');
            const empty = document.getElementById('saleItemsEmpty');
            const subtotalElem = document.getElementById('saleSubtotal');
            const totalElem = document.getElementById('saleTotal');

            if (state.currentSale.itens.length === 0) {
                body.innerHTML = '';
                empty.classList.remove('hidden');
                subtotalElem.textContent = formatCurrency(0);
                totalElem.textContent = formatCurrency(0);
                return;
            }

            empty.classList.add('hidden');
            let total = 0;

            body.innerHTML = state.currentSale.itens.map((item, index) => {
                const itemTotal = item.qtde * item.preco_venda;
                total += itemTotal;
                return `
                    <tr class="flex flex-wrap sm:table-row border-b border-slate-100 dark:border-zinc-800 py-4 sm:py-0">
                        <!-- 1. Produto (Ocupa linha inteira no mobile) -->
                        <td class="w-full sm:w-auto sm:table-cell py-2 sm:py-4">
                            <div class="flex flex-col">
                                <span class="text-base sm:text-sm font-bold text-slate-900 dark:text-white">${item.nome}</span>
                                <span class="text-[10px] text-slate-400">ID: ${item.id_produto}</span>
                            </div>
                        </td>
                        
                        <!-- 2. Quantidade -->
                        <td class="flex-1 sm:table-cell py-2 sm:py-4">
                            <label class="sm:hidden text-[10px] font-bold text-slate-400 uppercase mb-1 block">Qtde</label>
                            <div class="flex items-center gap-2">
                                <button onclick="updateSaleItemQty(${index}, -1)" class="size-8 sm:size-6 rounded bg-slate-100 dark:bg-zinc-800 flex items-center justify-center hover:bg-primary/20 hover:text-primary transition-colors">
                                    <span class="material-symbols-outlined text-xs">remove</span>
                                </button>
                                <span class="text-sm font-bold w-8 text-center">${item.qtde}</span>
                                <button onclick="updateSaleItemQty(${index}, 1)" class="size-8 sm:size-6 rounded bg-slate-100 dark:bg-zinc-800 flex items-center justify-center hover:bg-primary/20 hover:text-primary transition-colors">
                                    <span class="material-symbols-outlined text-xs">add</span>
                                </button>
                            </div>
                        </td>

                        <!-- 3. Preço -->
                        <td class="flex-1 sm:table-cell py-2 sm:py-4">
                            <label class="sm:hidden text-[10px] font-bold text-slate-400 uppercase mb-1 block">Preço</label>
                            <div class="flex items-center gap-2">
                                <button onclick="updateSaleItemPrice(${index}, -1)" class="size-8 sm:size-6 rounded bg-slate-100 dark:bg-zinc-800 flex items-center justify-center hover:bg-primary/20 hover:text-primary transition-colors">
                                    <span class="material-symbols-outlined text-xs">remove</span>
                                </button>
                                <input type="number" step="0.01" value="${item.preco_venda}" 
                                    onchange="updateSaleItemPriceValue(${index}, this.value)" 
                                    class="text-sm font-bold w-20 bg-transparent border-none text-center focus:ring-0 p-0 text-slate-700 dark:text-zinc-300">
                                <button onclick="updateSaleItemPrice(${index}, 1)" class="size-8 sm:size-6 rounded bg-slate-100 dark:bg-zinc-800 flex items-center justify-center hover:bg-primary/20 hover:text-primary transition-colors">
                                    <span class="material-symbols-outlined text-xs">add</span>
                                </button>
                            </div>
                        </td>

                        <!-- 4. Total -->
                        <td class="flex-1 sm:table-cell py-2 sm:py-4">
                            <label class="sm:hidden text-[10px] font-bold text-slate-400 uppercase mb-1 block">Total Item</label>
                            <span class="text-sm sm:text-sm font-black sm:font-bold text-primary sm:text-slate-900 dark:sm:text-white">
                                ${formatCurrency(itemTotal)}
                            </span>
                        </td>

                        <!-- 5. Ações (Excluir) -->
                        <td class="w-auto sm:table-cell py-2 sm:py-4 sm:text-right">
                            <button onclick="removeFromSale(${index})" class="p-2 sm:p-1 text-slate-300 hover:text-red-500 transition-colors flex items-center gap-1">
                                <span class="material-symbols-outlined text-xl">delete</span>
                                <span class="sm:hidden text-xs font-bold text-red-500">Excluir</span>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            state.currentSale.valor_total = total;
            subtotalElem.textContent = formatCurrency(total);
            totalElem.textContent = formatCurrency(total);
        }

        function addToSale(product) {
            const existingItem = state.currentSale.itens.find(item => item.id_produto === product.id_produto);
            if (existingItem) {
                existingItem.qtde += 1;
            } else {
                state.currentSale.itens.push({
                    id_produto: product.id_produto,
                    nome: product.nome,
                    qtde: 1,
                    preco_venda: product.preco_venda
                });
            }
            renderSaleItems();
            document.getElementById('saleProductSearch').value = '';
            document.getElementById('productSearchResults').classList.add('hidden');
        }

        function removeFromSale(index) {
            state.currentSale.itens.splice(index, 1);
            renderSaleItems();
        }

        function updateSaleItemQty(index, delta) {
            const item = state.currentSale.itens[index];
            item.qtde += delta;
            if (item.qtde <= 0) {
                removeFromSale(index);
            } else {
                renderSaleItems();
            }
        }

        function updateSaleItemPrice(index, delta) {
            const item = state.currentSale.itens[index];
            item.preco_venda = Math.max(0, (parseFloat(item.preco_venda) || 0) + delta);
            renderSaleItems();
        }

        function updateSaleItemPriceValue(index, value) {
            const item = state.currentSale.itens[index];
            item.preco_venda = Math.max(0, parseFloat(value) || 0);
            renderSaleItems();
        }

        async function finishSale() {
            if (state.currentSale.itens.length === 0) {
                alert('Adicione pelo menos um item à venda.');
                return;
            }

            const btn = document.getElementById('finishSaleBtn');
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.textContent = 'Processando...';

            const saleData = {
                id_cliente: document.getElementById('saleClientSelect').value ? parseInt(document.getElementById('saleClientSelect').value) : null,
                forma_pagamento: document.getElementById('salePaymentMethod').value,
                status_pagamento: document.getElementById('salePaymentStatus').value,
                valor_entrada: parseFloat(document.getElementById('saleDownPayment').value) || 0,
                valor_total: state.currentSale.valor_total,
                itens: state.currentSale.itens.map(item => ({
                    id_produto: item.id_produto,
                    qtde: item.qtde,
                    valor_unitario: item.preco_venda
                }))
            };

            try {
                const method = state.currentSale.id_vendas ? 'PUT' : 'POST';
                const url = state.currentSale.id_vendas ? `/sales/${state.currentSale.id_vendas}` : '/sales/';

                await apiRequest(url, {
                    method: method,
                    body: JSON.stringify(saleData)
                });

                alert(state.currentSale.id_vendas ? 'Venda atualizada com sucesso!' : 'Venda realizada com sucesso!');
                initNewSale();
                switchView('receivables');
            } catch (error) {
                console.error('Erro ao processar venda:', error);
                alert(`Erro ao processar venda: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }

        function toggleDownPaymentField() {
            const status = document.getElementById('salePaymentStatus').value;
            const group = document.getElementById('saleDownPaymentGroup');
            if (status === 'Parcial') {
                group.classList.remove('hidden');
                document.getElementById('saleDownPayment').focus();
            } else {
                group.classList.add('hidden');
                document.getElementById('saleDownPayment').value = '';
            }
        }

        function updateCategorySelects() {
            const select = document.getElementById('productCategory');
            if (select) {
                const options = state.categories.map(cat => `
                    <option value="${cat.id_categoria}">${cat.nome}</option>
                `).join('');
                select.innerHTML = '<option value="">Sem Categoria</option>' + options;
            }
        }

        function renderCategories() {
            const grid = document.getElementById('categoriesGrid');
            const tableContainer = document.getElementById('categoriesTableContainer');
            const tableBody = document.getElementById('categoriesTableBody');
            const emptyState = document.getElementById('categoriesEmptyState');

            if (state.categoryViewMode === 'grid') {
                grid.classList.remove('hidden');
                tableContainer.classList.add('hidden');
            } else {
                grid.classList.add('hidden');
                tableContainer.classList.remove('hidden');
            }

            if (state.categories.length === 0) {
                grid.classList.add('hidden');
                tableContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            // Filter based on search query
            const filteredCategories = state.searchQuery
                ? state.categories.filter(c =>
                    c.nome.toLowerCase().includes(state.searchQuery.toLowerCase())
                )
                : state.categories;

            state.pagination.categories.totalItems = filteredCategories.length;

            const start = (state.pagination.categories.currentPage - 1) * state.pagination.categories.itemsPerPage;
            const end = start + state.pagination.categories.itemsPerPage;
            const paginatedCategories = filteredCategories.slice(start, end);

            if (paginatedCategories.length === 0 && state.searchQuery) {
                const noResultHtml = `
                    <div class="col-span-full text-center py-16">
                        <span class="material-symbols-outlined text-6xl text-slate-300 dark:text-zinc-700 mb-4">search_off</span>
                        <h3 class="text-xl font-bold text-slate-700 dark:text-zinc-300 mb-2">Nenhum resultado encontrado</h3>
                        <p class="text-slate-500 dark:text-zinc-400">Não encontramos nenhuma categoria com o termo "${state.searchQuery}"</p>
                    </div>
                `;
                grid.innerHTML = noResultHtml;
                tableBody.innerHTML = `<tr><td colspan="2">${noResultHtml}</td></tr>`;
                updatePaginationFooter();
                return;
            }

            if (state.categoryViewMode === 'grid') {
                grid.innerHTML = paginatedCategories.map(cat => `
                    <div class="bg-white dark:bg-zinc-900 p-6 rounded-xl border border-slate-200 dark:border-zinc-800 hover:shadow-lg transition-all card-hover text-center">
                        <div class="size-12 rounded-full bg-primary/10 flex items-center justify-center text-primary mx-auto mb-4">
                            <span class="material-symbols-outlined text-2xl">category</span>
                        </div>
                        <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4">${cat.nome}</h3>
                        <div class="flex justify-center gap-2 pt-4 border-t border-slate-100 dark:border-zinc-800">
                            <button onclick="editCategory(${cat.id_categoria})" class="btn btn-secondary p-2" title="Editar">
                                <span class="material-symbols-outlined text-lg">edit</span>
                            </button>
                            <button onclick="deleteCategory(${cat.id_categoria}, '${cat.nome.replace(/'/g, "\\'")}')" class="btn btn-secondary p-2 text-red-500 hover:bg-red-50" title="Excluir">
                                <span class="material-symbols-outlined text-lg">delete</span>
                            </button>
                        </div>
                    </div>
                `).join('');
            } else {
                tableBody.innerHTML = paginatedCategories.map(cat => `
                    <tr class="hover:bg-slate-50 dark:hover:bg-zinc-800/50 transition-colors border-b border-slate-100 dark:border-zinc-800/50">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="size-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                                    <span class="material-symbols-outlined text-sm">category</span>
                                </div>
                                <span class="text-sm font-bold text-slate-900 dark:text-white capitalize">${cat.nome}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex justify-end gap-1">
                                <button onclick="editCategory(${cat.id_categoria})" class="p-1.5 text-slate-400 hover:text-primary transition-colors">
                                    <span class="material-symbols-outlined text-lg">edit</span>
                                </button>
                                <button onclick="deleteCategory(${cat.id_categoria}, '${cat.nome.replace(/'/g, "\\'")}')" class="p-1.5 text-slate-400 hover:text-red-500 transition-colors">
                                    <span class="material-symbols-outlined text-lg">delete</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
            updatePaginationFooter();
        }

        function updateCategoryViewMode(mode) {
            state.categoryViewMode = mode;
            const gridBtn = document.getElementById('categoryGridViewBtn');
            const tableBtn = document.getElementById('categoryTableViewBtn');

            if (mode === 'grid') {
                gridBtn.classList.add('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                gridBtn.classList.remove('text-slate-400');
                tableBtn.classList.remove('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                tableBtn.classList.add('text-slate-400');
            } else {
                tableBtn.classList.add('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                tableBtn.classList.remove('text-slate-400');
                gridBtn.classList.remove('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                gridBtn.classList.add('text-slate-400');
            }
            renderCategories();
        }

        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            const tableContainer = document.getElementById('productsTableContainer');
            const tableBody = document.getElementById('productsTableBody');
            const emptyState = document.getElementById('productsEmptyState');

            if (state.productViewMode === 'grid') {
                grid.classList.remove('hidden');
                tableContainer.classList.add('hidden');
            } else {
                grid.classList.add('hidden');
                tableContainer.classList.remove('hidden');
            }

            if (state.products.length === 0) {
                grid.classList.add('hidden');
                tableContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            // Filter based on search query
            const filteredProducts = state.searchQuery
                ? state.products.filter(p =>
                    p.nome.toLowerCase().includes(state.searchQuery.toLowerCase()) ||
                    (p.categoria && p.categoria.nome.toLowerCase().includes(state.searchQuery.toLowerCase()))
                )
                : state.products;

            state.pagination.products.totalItems = filteredProducts.length;

            const start = (state.pagination.products.currentPage - 1) * state.pagination.products.itemsPerPage;
            const end = start + state.pagination.products.itemsPerPage;
            const paginatedProducts = filteredProducts.slice(start, end);

            if (paginatedProducts.length === 0 && state.searchQuery) {
                const noResultHtml = `
                    <div class="col-span-full text-center py-16">
                        <span class="material-symbols-outlined text-6xl text-slate-300 dark:text-zinc-700 mb-4">search_off</span>
                        <h3 class="text-xl font-bold text-slate-700 dark:text-zinc-300 mb-2">Nenhum resultado encontrado</h3>
                        <p class="text-slate-500 dark:text-zinc-400">Não encontramos nenhum produto com o termo "${state.searchQuery}"</p>
                    </div>
                `;
                grid.innerHTML = noResultHtml;
                tableBody.innerHTML = `<tr><td colspan="5">${noResultHtml}</td></tr>`;
                updatePaginationFooter();
                return;
            }

            if (state.productViewMode === 'grid') {
                grid.innerHTML = paginatedProducts.map(product => `
                    <div class="bg-white dark:bg-zinc-900 p-6 rounded-xl border border-slate-200 dark:border-zinc-800 hover:shadow-lg transition-all card-hover">
                        <div class="flex items-start justify-between mb-4">
                            <div class="size-12 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                                <span class="material-symbols-outlined text-2xl">inventory_2</span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editProduct(${product.id_produto})" class="p-2 text-slate-400 hover:text-primary transition-colors" title="Editar">
                                    <span class="material-symbols-outlined text-lg">edit</span>
                                </button>
                                <button onclick="deleteProduct(${product.id_produto}, '${product.nome.replace(/'/g, "\\'")}')" class="p-2 text-slate-400 hover:text-red-500 transition-colors" title="Excluir">
                                    <span class="material-symbols-outlined text-lg">delete</span>
                                </button>
                            </div>
                        </div>
                        <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-1">${product.nome}</h3>
                        <span class="inline-block px-2.5 py-0.5 rounded-full text-xs font-bold bg-slate-100 dark:bg-zinc-800 text-slate-600 dark:text-zinc-400 mb-4">
                            ${product.categoria ? product.categoria.nome : 'Sem Categoria'}
                        </span>
                        <div class="space-y-1">
                            <div class="text-xs text-slate-500 dark:text-zinc-400">Preço de Venda</div>
                            <div class="text-xl font-black text-primary">${formatCurrency(product.preco_venda)}</div>
                            ${product.preco_custo ? `<div class="text-[10px] text-slate-400 italic">Custo: ${formatCurrency(product.preco_custo)}</div>` : ''}
                        </div>
                    </div>
                `).join('');
            } else {
                tableBody.innerHTML = paginatedProducts.map(product => `
                    <tr class="hover:bg-slate-50 dark:hover:bg-zinc-800/50 transition-colors border-b border-slate-100 dark:border-zinc-800/50">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="size-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                                    <span class="material-symbols-outlined text-sm">inventory_2</span>
                                </div>
                                <span class="text-sm font-bold text-slate-900 dark:text-white capitalize">${product.nome}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-600 dark:text-zinc-400">
                            ${product.categoria ? product.categoria.nome : '-'}
                        </td>
                        <td class="px-6 py-4 text-sm text-right font-medium text-slate-500">
                            ${formatCurrency(product.preco_custo)}
                        </td>
                        <td class="px-6 py-4 text-sm text-right font-black text-primary">
                            ${formatCurrency(product.preco_venda)}
                        </td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex justify-end gap-1">
                                <button onclick="editProduct(${product.id_produto})" class="p-1.5 text-slate-400 hover:text-primary transition-colors">
                                    <span class="material-symbols-outlined text-lg">edit</span>
                                </button>
                                <button onclick="deleteProduct(${product.id_produto}, '${product.nome.replace(/'/g, "\\'")}')" class="p-1.5 text-slate-400 hover:text-red-500 transition-colors">
                                    <span class="material-symbols-outlined text-lg">delete</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
            updatePaginationFooter();
        }

        function updateProductViewMode(mode) {
            state.productViewMode = mode;
            const gridBtn = document.getElementById('productGridViewBtn');
            const tableBtn = document.getElementById('productTableViewBtn');

            if (mode === 'grid') {
                gridBtn.classList.add('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                gridBtn.classList.remove('text-slate-400');
                tableBtn.classList.remove('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                tableBtn.classList.add('text-slate-400');
            } else {
                tableBtn.classList.add('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                tableBtn.classList.remove('text-slate-400');
                gridBtn.classList.remove('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                gridBtn.classList.add('text-slate-400');
            }
            renderProducts();
        }

        function openProductModal(product = null) {
            const modal = document.getElementById('productModal');
            const title = document.getElementById('productModalTitle');
            const form = document.getElementById('productForm');

            form.reset();
            document.getElementById('productId').value = '';

            if (product) {
                title.textContent = 'Editar Produto';
                document.getElementById('productId').value = product.id_produto;
                document.getElementById('productName').value = product.nome;
                document.getElementById('productCategory').value = product.id_categoria || '';
                document.getElementById('productCostPrice').value = product.preco_custo;
                document.getElementById('productSalePrice').value = product.preco_venda;
            } else {
                title.textContent = 'Novo Produto';
            }

            modal.classList.remove('hidden');
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.add('hidden');
        }

        function openCategoryModal(category = null) {
            const modal = document.getElementById('categoryModal');
            const title = document.getElementById('categoryModalTitle');
            const form = document.getElementById('categoryForm');

            form.reset();
            document.getElementById('categoryId').value = '';

            if (category) {
                title.textContent = 'Editar Categoria';
                document.getElementById('categoryId').value = category.id_categoria;
                document.getElementById('categoryName').value = category.nome;
            } else {
                title.textContent = 'Nova Categoria';
            }

            modal.classList.remove('hidden');
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.add('hidden');
        }

        function editCategory(id) {
            const category = state.categories.find(c => c.id_categoria === id);
            if (category) openCategoryModal(category);
        }

        function deleteCategory(id, name) {
            document.getElementById('deleteCategoryName').textContent = name;
            document.getElementById('confirmDeleteCategoryBtn').onclick = async () => {
                try {
                    await apiRequest(`/products/categories/${id}`, { method: 'DELETE' });
                    document.getElementById('deleteCategoryModal').classList.add('hidden');
                    await loadCategories();
                } catch (error) {
                    console.error('Erro ao excluir categoria:', error);
                    alert(`Erro ao excluir categoria: ${error.message}`);
                }
            };
            document.getElementById('deleteCategoryModal').classList.remove('hidden');
        }

        function closeDeleteCategoryModal() {
            document.getElementById('deleteCategoryModal').classList.add('hidden');
        }

        async function saveProduct(e) {
            e.preventDefault();
            console.log("Iniciando saveProduct...");
            const id = document.getElementById('productId').value;
            const data = {
                nome: document.getElementById('productName').value,
                id_categoria: document.getElementById('productCategory').value ? parseInt(document.getElementById('productCategory').value) : null,
                preco_custo: document.getElementById('productCostPrice').value !== "" ? parseFloat(document.getElementById('productCostPrice').value) : null,
                preco_venda: document.getElementById('productSalePrice').value !== "" ? parseFloat(document.getElementById('productSalePrice').value) : 0
            };

            console.log("Dados do produto:", data);

            try {
                const method = id ? 'PUT' : 'POST';
                const url = id ? `/products/${id}` : '/products/';
                console.log(`Chamando API: ${method} ${url}`);

                const response = await apiRequest(url, {
                    method: method,
                    body: JSON.stringify(data)
                });

                console.log("Resposta da API:", response);

                if (response) {
                    closeProductModal();
                    await loadProducts();
                    console.log("Produto salvo e lista recarregada.");
                }
            } catch (error) {
                console.error('Erro detalhado ao salvar produto:', error);
                alert(`Erro ao salvar produto: ${error.message}`);
            }
        }

        async function saveCategory(e) {
            e.preventDefault();
            const id = document.getElementById('categoryId')?.value;
            const data = { nome: document.getElementById('categoryName').value };

            try {
                const method = id ? 'PUT' : 'POST';
                const url = id ? `/products/categories/${id}` : '/products/categories/';

                const response = await apiRequest(url, {
                    method: method,
                    body: JSON.stringify(data)
                });

                if (response) {
                    closeCategoryModal();
                    await loadCategories();
                    if (state.currentView === 'products') {
                        updateCategorySelects();
                    } else if (state.currentView === 'categories') {
                        renderCategories();
                    }
                }
            } catch (error) {
                console.error('Erro ao salvar categoria:', error);
                alert(`Erro ao salvar categoria: ${error.message}`);
            }
        }

        function editProduct(id) {
            const product = state.products.find(p => p.id_produto === id);
            if (product) openProductModal(product);
        }

        function deleteProduct(id, name) {
            document.getElementById('deleteProductName').textContent = name;
            document.getElementById('confirmDeleteProductBtn').onclick = async () => {
                try {
                    await apiRequest(`/products/${id}`, { method: 'DELETE' });
                    document.getElementById('deleteProductModal').classList.add('hidden');
                    loadProducts();
                } catch (error) {
                    console.error('Erro ao excluir produto:', error);
                    alert('Erro ao excluir produto. Tente novamente.');
                }
            };
            document.getElementById('deleteProductModal').classList.remove('hidden');
        }

        function closeDeleteProductModal() {
            document.getElementById('deleteProductModal').classList.add('hidden');
        }

        // Employee Management Functions
        async function loadEmployees() {
            try {
                const response = await apiRequest('/finance/employees/');
                if (response) {
                    state.employees = response;
                    if (state.currentView === 'employees') {
                        renderEmployees();
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar funcionários:', error);
            }
        }

        function renderEmployees() {
            const grid = document.getElementById('employeesGrid');
            const tableContainer = document.getElementById('employeesTableContainer');
            const tableBody = document.getElementById('employeesTableBody');
            const emptyState = document.getElementById('employeesEmptyState');

            if (state.employeeViewMode === 'grid') {
                grid.classList.remove('hidden');
                tableContainer.classList.add('hidden');
            } else {
                grid.classList.add('hidden');
                tableContainer.classList.remove('hidden');
            }

            if (state.employees.length === 0) {
                grid.classList.add('hidden');
                tableContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            const filteredEmployees = state.searchQuery
                ? state.employees.filter(e =>
                    e.nome.toLowerCase().includes(state.searchQuery.toLowerCase())
                )
                : state.employees;

            state.pagination.employees.totalItems = filteredEmployees.length;

            const start = (state.pagination.employees.currentPage - 1) * state.pagination.employees.itemsPerPage;
            const end = start + state.pagination.employees.itemsPerPage;
            const paginatedEmployees = filteredEmployees.slice(start, end);

            if (paginatedEmployees.length === 0 && state.searchQuery) {
                const noResultHtml = `
                    <div class="col-span-full text-center py-16">
                        <span class="material-symbols-outlined text-6xl text-slate-300 dark:text-zinc-700 mb-4">search_off</span>
                        <h3 class="text-xl font-bold text-slate-700 dark:text-zinc-300 mb-2">Nenhum funcionário encontrado</h3>
                        <p class="text-slate-500 dark:text-zinc-400">Não encontramos nenhum funcionário com o termo "${state.searchQuery}"</p>
                    </div>
                `;
                grid.innerHTML = noResultHtml;
                tableBody.innerHTML = `<tr><td colspan="5">${noResultHtml}</td></tr>`;
                updatePaginationFooter();
                return;
            }

            if (state.employeeViewMode === 'grid') {
                grid.innerHTML = paginatedEmployees.map(emp => `
                    <div class="bg-white dark:bg-zinc-900 p-6 rounded-xl border border-slate-200 dark:border-zinc-800 hover:shadow-lg transition-all card-hover">
                        <div class="flex items-start justify-between mb-4">
                            <div class="size-12 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                                <span class="material-symbols-outlined text-2xl">badge</span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editEmployee(${emp.id_funcionario})" class="p-2 text-slate-400 hover:text-primary transition-colors">
                                    <span class="material-symbols-outlined text-lg">edit</span>
                                </button>
                                <button onclick="deleteEmployee(${emp.id_funcionario}, '${emp.nome.replace(/'/g, "\\'")}')" class="p-2 text-slate-400 hover:text-red-500 transition-colors">
                                    <span class="material-symbols-outlined text-lg">delete</span>
                                </button>
                            </div>
                        </div>
                        <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-1">${emp.nome}</h3>
                        <div class="space-y-3 pb-4 mb-4 border-b border-slate-100 dark:border-zinc-800">
                            <p class="text-sm text-slate-500 dark:text-zinc-400 flex items-center gap-2">
                                <span class="material-symbols-outlined text-base">call</span>
                                ${emp.telefone || 'Sem telefone'}
                            </p>
                            <p class="text-sm text-slate-500 dark:text-zinc-400 flex items-center gap-2">
                                <span class="material-symbols-outlined text-base">event</span>
                                Admissão: ${emp.data_admissao ? formatSimpleDate(emp.data_admissao) : 'Não informada'}
                            </p>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-slate-500 dark:text-zinc-400 flex items-center gap-1.5">
                                <span class="material-symbols-outlined text-base">payments</span>
                                Salário
                            </span>
                            <span class="font-bold text-primary">${formatCurrency(emp.salario)}</span>
                        </div>
                    </div>
                `).join('');
            } else {
                tableBody.innerHTML = paginatedEmployees.map(emp => `
                    <tr class="hover:bg-slate-50 dark:hover:bg-zinc-800/50 transition-colors border-b border-slate-100 dark:border-zinc-800/50">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="size-8 rounded-full bg-primary/20 flex items-center justify-center text-primary font-bold text-xs">
                                    ${emp.nome.charAt(0).toUpperCase()}
                                </div>
                                <span class="text-sm font-bold text-slate-900 dark:text-white">${emp.nome}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-600 dark:text-zinc-400">${emp.telefone || '-'}</td>
                        <td class="px-6 py-4 text-sm font-bold text-slate-900 dark:text-white">${formatCurrency(emp.salario)}</td>
                        <td class="px-6 py-4 text-sm text-slate-600 dark:text-zinc-400">${emp.data_admissao ? formatSimpleDate(emp.data_admissao) : '-'}</td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex justify-end gap-1">
                                <button onclick="editEmployee(${emp.id_funcionario})" class="p-1.5 text-slate-400 hover:text-primary transition-colors">
                                    <span class="material-symbols-outlined text-lg">edit</span>
                                </button>
                                <button onclick="deleteEmployee(${emp.id_funcionario}, '${emp.nome.replace(/'/g, "\\'")}')" class="p-1.5 text-slate-400 hover:text-red-500 transition-colors">
                                    <span class="material-symbols-outlined text-lg">delete</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
            updatePaginationFooter();
        }

        async function saveEmployee(e) {
            e.preventDefault();
            const id = document.getElementById('employeeId').value;
            const data = {
                nome: document.getElementById('employeeName').value,
                telefone: document.getElementById('employeePhone').value || null,
                salario: parseFloat(document.getElementById('employeeSalary').value) || 0,
                data_admissao: document.getElementById('employeeAdmissionDate').value || null
            };

            try {
                const method = id ? 'PUT' : 'POST';
                const url = id ? `/finance/employees/${id}` : '/finance/employees/';

                const response = await apiRequest(url, {
                    method: method,
                    body: JSON.stringify(data)
                });

                if (response) {
                    closeEmployeeModal();
                    await loadEmployees();
                }
            } catch (error) {
                console.error('Erro ao salvar funcionário:', error);
                alert(`Erro ao salvar funcionário: ${error.message}`);
            }
        }

        function openEmployeeModal(employee = null) {
            const modal = document.getElementById('employeeModal');
            const title = document.getElementById('employeeModalTitle');
            const form = document.getElementById('employeeForm');

            form.reset();
            document.getElementById('employeeId').value = '';

            if (employee) {
                title.textContent = 'Editar Funcionário';
                document.getElementById('employeeId').value = employee.id_funcionario;
                document.getElementById('employeeName').value = employee.nome;
                document.getElementById('employeePhone').value = employee.telefone || '';
                document.getElementById('employeeSalary').value = employee.salario;
                document.getElementById('employeeAdmissionDate').value = employee.data_admissao || '';
            } else {
                title.textContent = 'Novo Funcionário';
            }

            modal.classList.remove('hidden');
        }

        function closeEmployeeModal() {
            document.getElementById('employeeModal').classList.add('hidden');
        }

        function editEmployee(id) {
            const employee = state.employees.find(e => e.id_funcionario === id);
            if (employee) openEmployeeModal(employee);
        }

        function deleteEmployee(id, name) {
            document.getElementById('deleteEmployeeName').textContent = name;
            document.getElementById('confirmDeleteEmployeeBtn').onclick = async () => {
                try {
                    await apiRequest(`/finance/employees/${id}`, { method: 'DELETE' });
                    document.getElementById('deleteEmployeeModal').classList.add('hidden');
                    await loadEmployees();
                } catch (error) {
                    console.error('Erro ao excluir funcionário:', error);
                    alert(`Erro ao excluir funcionário: ${error.message}`);
                }
            };
            document.getElementById('deleteEmployeeModal').classList.remove('hidden');
        }

        function closeDeleteEmployeeModal() {
            document.getElementById('deleteEmployeeModal').classList.add('hidden');
        }

        function updateEmployeeViewMode(mode) {
            state.employeeViewMode = mode;
            const gridBtn = document.getElementById('employeeGridViewBtn');
            const tableBtn = document.getElementById('employeeTableViewBtn');

            if (mode === 'grid') {
                gridBtn.classList.add('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                gridBtn.classList.remove('text-slate-400');
                tableBtn.classList.remove('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                tableBtn.classList.add('text-slate-400');
            } else {
                tableBtn.classList.add('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                tableBtn.classList.remove('text-slate-400');
                gridBtn.classList.remove('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                gridBtn.classList.add('text-slate-400');
            }
            renderEmployees();
        }

        // Supplier Management Functions
        async function loadSuppliers() {
            try {
                const response = await apiRequest('/finance/suppliers/');
                if (response) {
                    state.suppliers = response;
                    if (state.currentView === 'suppliers') {
                        renderSuppliers();
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar fornecedores:', error);
            }
        }

        function renderSuppliers() {
            const grid = document.getElementById('suppliersGrid');
            const tableContainer = document.getElementById('suppliersTableContainer');
            const tableBody = document.getElementById('suppliersTableBody');
            const emptyState = document.getElementById('suppliersEmptyState');

            if (state.supplierViewMode === 'grid') {
                grid.classList.remove('hidden');
                tableContainer.classList.add('hidden');
            } else {
                grid.classList.add('hidden');
                tableContainer.classList.remove('hidden');
            }

            if (state.suppliers.length === 0) {
                grid.classList.add('hidden');
                tableContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            const filteredSuppliers = state.searchQuery
                ? state.suppliers.filter(s =>
                    s.nome.toLowerCase().includes(state.searchQuery.toLowerCase()) ||
                    (s.contato && s.contato.toLowerCase().includes(state.searchQuery.toLowerCase()))
                )
                : state.suppliers;

            state.pagination.suppliers.totalItems = filteredSuppliers.length;

            const start = (state.pagination.suppliers.currentPage - 1) * state.pagination.suppliers.itemsPerPage;
            const end = start + state.pagination.suppliers.itemsPerPage;
            const paginatedSuppliers = filteredSuppliers.slice(start, end);

            if (paginatedSuppliers.length === 0 && state.searchQuery) {
                const noResultHtml = `
                    <div class="col-span-full text-center py-16">
                        <span class="material-symbols-outlined text-6xl text-slate-300 dark:text-zinc-700 mb-4">search_off</span>
                        <h3 class="text-xl font-bold text-slate-700 dark:text-zinc-300 mb-2">Nenhum fornecedor encontrado</h3>
                        <p class="text-slate-500 dark:text-zinc-400">Não encontramos nenhum fornecedor com o termo "${state.searchQuery}"</p>
                    </div>
                `;
                grid.innerHTML = noResultHtml;
                tableBody.innerHTML = `<tr><td colspan="4">${noResultHtml}</td></tr>`;
                updatePaginationFooter();
                return;
            }

            if (state.supplierViewMode === 'grid') {
                grid.innerHTML = paginatedSuppliers.map(sup => `
                    <div class="bg-white dark:bg-zinc-900 p-6 rounded-xl border border-slate-200 dark:border-zinc-800 hover:shadow-lg transition-all card-hover">
                        <div class="flex items-start justify-between mb-4">
                            <div class="size-12 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                                <span class="material-symbols-outlined text-2xl">local_shipping</span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editSupplier(${sup.id_fornecedor})" class="p-2 text-slate-400 hover:text-primary transition-colors">
                                    <span class="material-symbols-outlined text-lg">edit</span>
                                </button>
                                <button onclick="deleteSupplier(${sup.id_fornecedor}, '${sup.nome.replace(/'/g, "\\\'")}')" class="p-2 text-slate-400 hover:text-red-500 transition-colors">
                                    <span class="material-symbols-outlined text-lg">delete</span>
                                </button>
                            </div>
                        </div>
                        <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">${sup.nome}</h3>
                        <div class="space-y-2">
                            <p class="text-sm text-slate-500 dark:text-zinc-400 flex items-center gap-2">
                                <span class="material-symbols-outlined text-base">person</span>
                                ${sup.contato || 'Sem contato'}
                            </p>
                            <p class="text-sm text-slate-500 dark:text-zinc-400 flex items-center gap-2">
                                <span class="material-symbols-outlined text-base">call</span>
                                ${sup.telefone || 'Sem telefone'}
                            </p>
                        </div>
                    </div>
                `).join('');
            } else {
                tableBody.innerHTML = paginatedSuppliers.map(sup => `
                    <tr class="hover:bg-slate-50 dark:hover:bg-zinc-800/50 transition-colors border-b border-slate-100 dark:border-zinc-800/50">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="size-8 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold text-xs">
                                    ${sup.nome.charAt(0).toUpperCase()}
                                </div>
                                <span class="text-sm font-bold text-slate-900 dark:text-white">${sup.nome}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-600 dark:text-zinc-400">${sup.contato || '-'}</td>
                        <td class="px-6 py-4 text-sm text-slate-600 dark:text-zinc-400">${sup.telefone || '-'}</td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex justify-end gap-1">
                                <button onclick="editSupplier(${sup.id_fornecedor})" class="p-1.5 text-slate-400 hover:text-primary transition-colors">
                                    <span class="material-symbols-outlined text-lg">edit</span>
                                </button>
                                <button onclick="deleteSupplier(${sup.id_fornecedor}, '${sup.nome.replace(/'/g, "\\\'")}')" class="p-1.5 text-slate-400 hover:text-red-500 transition-colors">
                                    <span class="material-symbols-outlined text-lg">delete</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
            updatePaginationFooter();
        }

        async function saveSupplier(e) {
            e.preventDefault();
            const id = document.getElementById('supplierId').value;
            const data = {
                nome: document.getElementById('supplierName').value,
                contato: document.getElementById('supplierContact').value || null,
                telefone: document.getElementById('supplierPhone').value || null
            };

            try {
                const method = id ? 'PUT' : 'POST';
                const url = id ? `/finance/suppliers/${id}` : '/finance/suppliers/';

                const response = await apiRequest(url, {
                    method: method,
                    body: JSON.stringify(data)
                });

                if (response) {
                    closeSupplierModal();
                    await loadSuppliers();
                }
            } catch (error) {
                console.error('Erro ao salvar fornecedor:', error);
                alert(`Erro ao salvar fornecedor: ${error.message}`);
            }
        }

        function openSupplierModal(supplier = null) {
            const modal = document.getElementById('supplierModal');
            const title = document.getElementById('supplierModalTitle');
            const form = document.getElementById('supplierForm');

            form.reset();
            document.getElementById('supplierId').value = '';

            if (supplier) {
                title.textContent = 'Editar Fornecedor';
                document.getElementById('supplierId').value = supplier.id_fornecedor;
                document.getElementById('supplierName').value = supplier.nome;
                document.getElementById('supplierContact').value = supplier.contato || '';
                document.getElementById('supplierPhone').value = supplier.telefone || '';
            } else {
                title.textContent = 'Novo Fornecedor';
            }

            modal.classList.remove('hidden');
        }

        function closeSupplierModal() {
            document.getElementById('supplierModal').classList.add('hidden');
        }

        function editSupplier(id) {
            const supplier = state.suppliers.find(s => s.id_fornecedor === id);
            if (supplier) openSupplierModal(supplier);
        }

        function deleteSupplier(id, name) {
            document.getElementById('deleteSupplierName').textContent = name;
            document.getElementById('confirmDeleteSupplierBtn').onclick = async () => {
                try {
                    await apiRequest(`/finance/suppliers/${id}`, { method: 'DELETE' });
                    document.getElementById('deleteSupplierModal').classList.add('hidden');
                    await loadSuppliers();
                } catch (error) {
                    console.error('Erro ao excluir fornecedor:', error);
                    alert(`Erro ao excluir fornecedor: ${error.message}`);
                }
            };
            document.getElementById('deleteSupplierModal').classList.remove('hidden');
        }

        function closeDeleteSupplierModal() {
            document.getElementById('deleteSupplierModal').classList.add('hidden');
        }

        function updateSupplierViewMode(mode) {
            state.supplierViewMode = mode;
            const gridBtn = document.getElementById('supplierGridViewBtn');
            const tableBtn = document.getElementById('supplierTableViewBtn');

            if (mode === 'grid') {
                gridBtn.classList.add('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                gridBtn.classList.remove('text-slate-400');
                tableBtn.classList.remove('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                tableBtn.classList.add('text-slate-400');
            } else {
                tableBtn.classList.add('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                tableBtn.classList.remove('text-slate-400');
                gridBtn.classList.remove('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                gridBtn.classList.add('text-slate-400');
            }
            renderSuppliers();
        }

        // Client Management Functions
        function renderClients() {
            const grid = document.getElementById('clientsGrid');
            const tableContainer = document.getElementById('clientsTableContainer');
            const tableBody = document.getElementById('clientsTableBody');
            const emptyState = document.getElementById('clientsEmptyState');

            // Toggle visibility based on state
            if (state.clientViewMode === 'grid') {
                grid.classList.remove('hidden');
                tableContainer.classList.add('hidden');
            } else {
                grid.classList.add('hidden');
                tableContainer.classList.remove('hidden');
            }

            if (state.clients.length === 0) {
                grid.classList.add('hidden');
                tableContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            // Filter based on search query
            const filteredClients = state.searchQuery
                ? state.clients.filter(c =>
                    c.nome.toLowerCase().includes(state.searchQuery.toLowerCase()) ||
                    (c.email && c.email.toLowerCase().includes(state.searchQuery.toLowerCase())) ||
                    (c.telefone && c.telefone.includes(state.searchQuery))
                )
                : state.clients;

            state.pagination.clients.totalItems = filteredClients.length;

            // Calculate slice for pagination
            const start = (state.pagination.clients.currentPage - 1) * state.pagination.clients.itemsPerPage;
            const end = start + state.pagination.clients.itemsPerPage;
            const paginatedClients = filteredClients.slice(start, end);

            if (paginatedClients.length === 0 && state.searchQuery) {
                const noResultHtml = `
                    <div class="col-span-full text-center py-16">
                        <span class="material-symbols-outlined text-6xl text-slate-300 dark:text-zinc-700 mb-4">search_off</span>
                        <h3 class="text-xl font-bold text-slate-700 dark:text-zinc-300 mb-2">Nenhum resultado encontrado</h3>
                        <p class="text-slate-500 dark:text-zinc-400">Não encontramos nenhum cliente com o termo "${state.searchQuery}"</p>
                    </div>
                `;
                grid.innerHTML = noResultHtml;
                tableBody.innerHTML = `<tr><td colspan="5">${noResultHtml}</td></tr>`;
                updatePaginationFooter();
                return;
            }

            if (state.clientViewMode === 'grid') {
                grid.innerHTML = paginatedClients.map(client => `
                    <div class="bg-white dark:bg-zinc-900 p-6 rounded-xl border border-slate-200 dark:border-zinc-800 hover:shadow-lg transition-all card-hover">
                        <div class="flex items-start justify-between mb-4">
                            <div class="size-12 rounded-full bg-primary/20 flex items-center justify-center text-primary font-bold text-lg">
                                ${client.nome.charAt(0).toUpperCase()}
                            </div>
                            <div class="flex gap-2">
                                <button onclick="openBatchPaymentModal(${client.id_cliente}, '${client.nome.replace(/'/g, "\\'")}')" class="p-2 text-slate-400 hover:text-emerald-500 transition-colors" title="Receber Valor">
                                    <span class="material-symbols-outlined text-lg">payments</span>
                                </button>
                                <button onclick="editClient(${client.id_cliente})" class="p-2 text-slate-400 hover:text-primary transition-colors" title="Editar">
                                    <span class="material-symbols-outlined text-lg">edit</span>
                                </button>
                                <button onclick="deleteClient(${client.id_cliente}, '${client.nome.replace(/'/g, "\\'")}')" class="p-2 text-slate-400 hover:text-red-500 transition-colors" title="Excluir">
                                    <span class="material-symbols-outlined text-lg">delete</span>
                                </button>
                            </div>
                        </div>
                        <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-1">${client.nome}</h3>
                        <div class="space-y-2 mt-4">
                            ${client.telefone ? `
                                <div class="flex items-center gap-2 text-sm text-slate-600 dark:text-zinc-400">
                                    <span class="material-symbols-outlined text-lg">call</span>
                                    <span>${client.telefone}</span>
                                </div>
                            ` : ''}
                            ${client.email ? `
                                <div class="flex items-center gap-2 text-sm text-slate-600 dark:text-zinc-400">
                                    <span class="material-symbols-outlined text-lg">email</span>
                                    <span class="truncate">${client.email}</span>
                                </div>
                            ` : ''}
                            <div class="flex items-center gap-2 text-sm text-slate-600 dark:text-zinc-400">
                                <span class="material-symbols-outlined text-lg">account_balance_wallet</span>
                                <span>Limite: <strong class="text-primary">${formatCurrency(client.limite_credito)}</strong></span>
                            </div>
                            <div class="flex items-center gap-2 text-sm text-slate-600 dark:text-zinc-400 pt-2 border-t border-slate-50 dark:border-zinc-800/50 mt-2">
                                <span class="material-symbols-outlined text-lg">account_balance</span>
                                <span>Saldo Devedor: <strong class="${parseFloat(client.saldo_devedor) > 0 ? 'text-rose-500' : 'text-slate-400'}">${formatCurrency(client.saldo_devedor)}</strong></span>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                tableBody.innerHTML = paginatedClients.map(client => `
                    <tr class="hover:bg-slate-50 dark:hover:bg-zinc-800/50 transition-colors border-b border-slate-100 dark:border-zinc-800/50">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="size-10 rounded-full bg-primary/20 flex items-center justify-center text-primary font-bold text-sm">
                                    ${client.nome.charAt(0).toUpperCase()}
                                </div>
                                <span class="text-sm font-bold text-slate-900 dark:text-white capitalize">${client.nome}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-center text-sm text-slate-600 dark:text-zinc-400">
                            ${client.telefone || '-'}
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-600 dark:text-zinc-400">
                            ${client.email || '-'}
                        </td>
                        <td class="px-6 py-4 text-sm font-bold text-slate-900 dark:text-white">
                            ${formatCurrency(client.limite_credito)}
                        </td>
                        <td class="px-6 py-4 text-sm font-black ${parseFloat(client.saldo_devedor) > 0 ? 'text-rose-500' : 'text-slate-400'}">
                            ${formatCurrency(client.saldo_devedor)}
                        </td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex justify-end gap-1">
                                <button onclick="openBatchPaymentModal(${client.id_cliente}, '${client.nome.replace(/'/g, "\\'")}')" class="p-1.5 text-slate-400 hover:text-emerald-500 transition-colors" title="Receber Valor">
                                    <span class="material-symbols-outlined text-lg">payments</span>
                                </button>
                                <button onclick="editClient(${client.id_cliente})" class="p-1.5 text-slate-400 hover:text-primary transition-colors">
                                    <span class="material-symbols-outlined text-lg">edit</span>
                                </button>
                                <button onclick="deleteClient(${client.id_cliente}, '${client.nome.replace(/'/g, "\\'")}')" class="p-1.5 text-slate-400 hover:text-red-500 transition-colors">
                                    <span class="material-symbols-outlined text-lg">delete</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
        }

        function updateClientViewMode(mode) {
            state.clientViewMode = mode;

            const gridBtn = document.getElementById('clientGridViewBtn');
            const tableBtn = document.getElementById('clientTableViewBtn');

            if (mode === 'grid') {
                gridBtn.classList.add('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                gridBtn.classList.remove('text-slate-400');
                tableBtn.classList.remove('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                tableBtn.classList.add('text-slate-400');
            } else {
                tableBtn.classList.add('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                tableBtn.classList.remove('text-slate-400');
                gridBtn.classList.remove('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                gridBtn.classList.add('text-slate-400');
            }

            renderClients();
        }

        function updatePaginationFooter() {
            let config;
            if (state.currentView === 'clients') config = state.pagination.clients;
            else if (state.currentView === 'products') config = state.pagination.products;
            else if (state.currentView === 'categories') config = state.pagination.categories;
            else if (state.currentView === 'employees') config = state.pagination.employees;
            else if (state.currentView === 'suppliers') config = state.pagination.suppliers;
            else if (state.currentView === 'receivables') config = state.pagination.receivables;
            else if (state.currentView === 'payables') config = state.pagination.payables;
            else if (state.currentView === 'advances') config = state.pagination.advances;

            if (!config) return;

            const totalPages = Math.ceil(config.totalItems / config.itemsPerPage) || 1;

            // Update labels
            document.getElementById('currentPageDisplay').textContent = config.currentPage;
            document.getElementById('totalPagesDisplay').textContent = totalPages;

            // Update buttons state
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');

            prevBtn.disabled = config.currentPage === 1;
            prevBtn.className = prevBtn.disabled
                ? 'flex items-center gap-2 px-4 py-2 text-sm font-bold text-slate-400 cursor-not-allowed bg-slate-50 dark:bg-zinc-800 rounded-lg border border-slate-200 dark:border-zinc-800 transition-all opacity-60'
                : 'flex items-center gap-2 px-4 py-2 text-sm font-bold text-slate-600 dark:text-zinc-300 hover:text-primary bg-white dark:bg-zinc-900 hover:bg-slate-50 dark:hover:bg-zinc-800 rounded-lg border border-slate-200 dark:border-zinc-800 transition-all shadow-sm';

            nextBtn.disabled = config.currentPage === totalPages;
            nextBtn.className = nextBtn.disabled
                ? 'flex items-center gap-2 px-4 py-2 text-sm font-bold text-slate-400 cursor-not-allowed bg-slate-50 dark:bg-zinc-800 rounded-lg border border-slate-200 dark:border-zinc-800 transition-all opacity-60'
                : 'flex items-center gap-2 px-4 py-2 text-sm font-bold text-primary-600 hover:text-white bg-white dark:bg-zinc-900 hover:bg-primary-600 rounded-lg border border-primary-600/20 hover:border-primary-600 transition-all shadow-sm';

            // Render Page Numbers
            const container = document.getElementById('pageNumbersContainer');
            let pagesHtml = '';

            const maxVisible = 5;
            let start = Math.max(1, config.currentPage - 2);
            let end = Math.min(totalPages, start + maxVisible - 1);

            if (end - start + 1 < maxVisible) {
                start = Math.max(1, end - maxVisible + 1);
            }

            if (start > 1) {
                pagesHtml += `<button onclick="goToPage(1)" class="size-9 flex items-center justify-center rounded-lg text-sm font-bold transition-all hover:bg-slate-100 dark:hover:bg-zinc-800 text-slate-600 dark:text-zinc-400">1</button>`;
                if (start > 2) pagesHtml += `<span class="text-slate-400 px-1">...</span>`;
            }

            for (let i = start; i <= end; i++) {
                const isActive = i === config.currentPage;
                pagesHtml += `
                    <button onclick="goToPage(${i})" 
                        class="size-9 flex items-center justify-center rounded-lg text-sm font-bold transition-all 
                        ${isActive
                        ? 'bg-primary text-white shadow-md'
                        : 'text-slate-600 dark:text-zinc-400 hover:bg-slate-100 dark:hover:bg-zinc-800'}">
                        ${i}
                    </button>
                `;
            }

            if (end < totalPages) {
                if (end < totalPages - 1) pagesHtml += `<span class="text-slate-400 px-1">...</span>`;
                pagesHtml += `<button onclick="goToPage(${totalPages})" class="size-9 flex items-center justify-center rounded-lg text-sm font-bold transition-all hover:bg-slate-100 dark:hover:bg-zinc-800 text-slate-600 dark:text-zinc-400">${totalPages}</button>`;
            }

            container.innerHTML = pagesHtml;
        }

        function goToPage(page) {
            let config;
            if (state.currentView === 'clients') config = state.pagination.clients;
            else if (state.currentView === 'products') config = state.pagination.products;
            else if (state.currentView === 'categories') config = state.pagination.categories;
            else if (state.currentView === 'employees') config = state.pagination.employees;
            else if (state.currentView === 'suppliers') config = state.pagination.suppliers;
            else if (state.currentView === 'payables') config = state.pagination.payables;
            else if (state.currentView === 'advances') config = state.pagination.advances;

            if (!config) return;
            config.currentPage = page;

            if (state.currentView === 'clients') renderClients();
            else if (state.currentView === 'products') renderProducts();
            else if (state.currentView === 'categories') renderCategories();
            else if (state.currentView === 'employees') renderEmployees();
            else if (state.currentView === 'suppliers') renderSuppliers();
            else if (state.currentView === 'payables') renderPayables();
            else if (state.currentView === 'advances') renderAdvances();

            updatePaginationFooter();
            // Scroll to top of the main content area
            document.querySelector('.overflow-y-auto').scrollTo({ top: 0, behavior: 'smooth' });
        }

        function openClientModal(clientId = null) {
            const modal = document.getElementById('clientModal');
            const title = document.getElementById('clientModalTitle');
            const form = document.getElementById('clientForm');

            form.reset();
            document.getElementById('clientId').value = '';

            if (clientId) {
                const client = state.clients.find(c => c.id_cliente === clientId);
                if (client) {
                    title.textContent = 'Editar Cliente';
                    document.getElementById('clientId').value = client.id_cliente;
                    document.getElementById('clientName').value = client.nome;
                    document.getElementById('clientPhone').value = client.telefone || '';
                    document.getElementById('clientEmail').value = client.email || '';
                    document.getElementById('clientCreditLimit').value = client.limite_credito || 0;
                }
            } else {
                title.textContent = 'Novo Cliente';
            }

            modal.classList.remove('hidden');
        }

        function closeClientModal() {
            document.getElementById('clientModal').classList.add('hidden');
        }

        function editClient(clientId) {
            openClientModal(clientId);
        }

        function deleteClient(clientId, clientName) {
            window.clientToDelete = clientId;
            document.getElementById('deleteClientName').textContent = clientName;
            document.getElementById('deleteClientModal').classList.remove('hidden');
        }

        function closeDeleteClientModal() {
            document.getElementById('deleteClientModal').classList.add('hidden');
            window.clientToDelete = null;
        }

        async function confirmDeleteClient() {
            if (!window.clientToDelete) return;

            try {
                await apiRequest(`/clients/${window.clientToDelete}`, {
                    method: 'DELETE'
                });

                await loadClients();
                closeDeleteClientModal();

                // Show success message (you can implement a toast notification here)
                console.log('Cliente excluído com sucesso!');
            } catch (error) {
                console.error('Error deleting client:', error);
                alert('Erro ao excluir cliente. Tente novamente.');
            }
        }

        async function saveClient(event) {
            event.preventDefault();

            const clientId = document.getElementById('clientId').value;
            const clientData = {
                nome: document.getElementById('clientName').value,
                telefone: document.getElementById('clientPhone').value || null,
                email: document.getElementById('clientEmail').value || null,
                limite_credito: parseFloat(document.getElementById('clientCreditLimit').value) || 0
            };

            try {
                if (clientId) {
                    // Update existing client
                    await apiRequest(`/clients/${clientId}`, {
                        method: 'PUT',
                        body: JSON.stringify(clientData)
                    });
                } else {
                    // Create new client
                    await apiRequest('/clients/', {
                        method: 'POST',
                        body: JSON.stringify(clientData)
                    });
                }

                await loadClients();
                closeClientModal();

                // Show success message
                console.log('Cliente salvo com sucesso!');
            } catch (error) {
                console.error('Error saving client:', error);
                alert('Erro ao salvar cliente. Tente novamente.');
            }
        }


        // Render Functions
        function renderSales() {
            const tableContainer = document.getElementById('salesTableContainer');
            const grid = document.getElementById('salesGrid');
            const tbody = document.getElementById('salesTableBody');

            if (state.salesViewMode === 'grid') {
                grid.classList.remove('hidden');
                tableContainer.classList.add('hidden');
            } else {
                grid.classList.add('hidden');
                tableContainer.classList.remove('hidden');
            }

            // Filter based on search query AND filter modal settings
            const filteredSales = state.sales.filter(sale => {
                // 1. Search Query Filter
                const client = state.clients.find(c => c.id_cliente === sale.id_cliente);
                const clientName = client ? client.nome : 'Consumidor Final (Balcão)';
                const matchesSearch = !state.searchQuery ||
                    clientName.toLowerCase().includes(state.searchQuery.toLowerCase()) ||
                    sale.id_vendas.toString().includes(state.searchQuery);

                if (!matchesSearch) return false;

                // 2. Date Filter
                const saleDate = new Date(sale.data_venda).toISOString().split('T')[0];
                if (state.filters.sales.startDate && saleDate < state.filters.sales.startDate) return false;
                if (state.filters.sales.endDate && saleDate > state.filters.sales.endDate) return false;

                // 3. Status Filter
                if (state.filters.sales.status && sale.status_pagamento !== state.filters.sales.status) return false;

                // 4. Payment Method Filter
                if (state.filters.sales.paymentMethod && sale.forma_pagamento !== state.filters.sales.paymentMethod) return false;

                // 5. Client Filter
                if (state.filters.sales.clientId && sale.id_cliente?.toString() !== state.filters.sales.clientId.toString()) return false;

                return true;
            });

            state.pagination.receivables.totalItems = filteredSales.length;
            const start = (state.pagination.receivables.currentPage - 1) * state.pagination.receivables.itemsPerPage;
            const end = start + state.pagination.receivables.itemsPerPage;
            const paginatedSales = filteredSales.slice(start, end);

            if (paginatedSales.length === 0) {
                const emptyMsg = `
                    <div class="col-span-full py-12 text-center text-slate-500 dark:text-zinc-400">
                        <span class="material-symbols-outlined text-5xl mb-2 opacity-50">${state.searchQuery || Object.values(state.filters.sales).some(v => v) ? 'search_off' : 'receipt_long'}</span>
                        <p class="text-sm font-medium">Nenhuma venda encontrada com os filtros atuais</p>
                        ${Object.values(state.filters.sales).some(v => v) ? '<button onclick="clearFilters()" class="mt-4 text-primary text-xs font-bold hover:underline">Limpar Filtros</button>' : ''}
                    </div>
                `;

                if (state.salesViewMode === 'grid') {
                    grid.innerHTML = emptyMsg;
                } else {
                    tbody.innerHTML = `<tr><td colspan="7">${emptyMsg}</td></tr>`;
                }
                return;
            }

            if (state.salesViewMode === 'grid') {
                grid.innerHTML = paginatedSales.map(sale => {
                    const client = state.clients.find(c => c.id_cliente === sale.id_cliente);
                    const clientName = client ? client.nome : 'Consumidor Final (Balcão)';
                    const statusClass = getStatusClass(sale.status_pagamento);

                    return `
                        <div class="bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-800 rounded-xl overflow-hidden hover:shadow-lg transition-all card-hover group">
                            <div class="p-5">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <span class="text-[10px] font-black uppercase tracking-widest text-slate-400">Venda #${sale.id_vendas}</span>
                                        <h3 class="text-sm font-bold text-slate-900 dark:text-white line-clamp-1 mt-0.5">${clientName}</h3>
                                    </div>
                                    <span class="status-badge ${statusClass}">${sale.status_pagamento}</span>
                                </div>
                                
                                <div class="flex items-center gap-3 mb-4 text-xs text-slate-500 dark:text-zinc-400">
                                    <div class="flex items-center gap-1">
                                        <span class="material-symbols-outlined text-sm">calendar_month</span>
                                        ${formatDate(sale.data_venda)}
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <span class="material-symbols-outlined text-sm">payments</span>
                                        ${sale.forma_pagamento ? getPaymentMethodLabel(sale.forma_pagamento) : '-'}
                                    </div>
                                </div>

                                <div class="flex items-end justify-between">
                                    <div>
                                        <p class="text-[10px] text-slate-400 font-bold uppercase mb-0.5">Total</p>
                                        <p class="text-lg font-black text-slate-900 dark:text-white leading-none">${formatCurrency(sale.valor_total)}</p>
                                    </div>
                                    <div class="flex gap-1">
                                        <button class="size-8 rounded-lg bg-slate-50 dark:bg-zinc-800 text-slate-400 hover:text-primary flex items-center justify-center transition-colors" onclick="viewSale(${sale.id_vendas})" title="Visualizar">
                                            <span class="material-symbols-outlined text-lg">visibility</span>
                                        </button>
                                        <button class="size-8 rounded-lg bg-slate-50 dark:bg-zinc-800 text-slate-400 hover:text-primary flex items-center justify-center transition-colors" onclick="editSale(${sale.id_vendas})" title="Editar">
                                            <span class="material-symbols-outlined text-lg">edit</span>
                                        </button>
                                        <button class="size-8 rounded-lg bg-slate-50 dark:bg-zinc-800 text-slate-400 hover:text-red-500 flex items-center justify-center transition-colors" onclick="deleteSale(${sale.id_vendas})" title="Excluir">
                                            <span class="material-symbols-outlined text-lg">delete</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                tbody.innerHTML = paginatedSales.map(sale => {
                    const client = state.clients.find(c => c.id_cliente === sale.id_cliente);
                    const clientName = client ? client.nome : 'Consumidor Final (Balcão)';

                    return `
                        <tr class="hover:bg-slate-50 dark:hover:bg-zinc-800/50 transition-colors">
                            <td class="px-6 py-4">
                                <span class="text-sm font-bold text-slate-900 dark:text-white">#${sale.id_vendas}</span>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-2">
                                    <div class="size-8 rounded-full bg-primary/20 flex items-center justify-center text-primary font-bold text-xs">
                                        ${clientName.charAt(0).toUpperCase()}
                                    </div>
                                    <span class="text-sm font-medium text-slate-700 dark:text-zinc-300">${clientName}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-sm text-slate-600 dark:text-zinc-400">
                                ${formatDate(sale.data_venda)}
                            </td>
                            <td class="px-6 py-4">
                                <span class="text-sm font-bold text-slate-900 dark:text-white">${formatCurrency(sale.valor_total)}</span>
                            </td>
                            <td class="px-6 py-4">
                                <span class="text-xs font-medium text-slate-600 dark:text-zinc-400">
                                    ${sale.forma_pagamento ? getPaymentMethodLabel(sale.forma_pagamento) : '-'}
                                </span>
                            </td>
                            <td class="px-6 py-4">
                                <span class="status-badge ${getStatusClass(sale.status_pagamento)}">
                                    ${sale.status_pagamento}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <div class="flex justify-end gap-1">
                                    <button class="p-1.5 text-slate-400 hover:text-primary transition-colors" onclick="viewSale(${sale.id_vendas})" title="Visualizar">
                                        <span class="material-symbols-outlined text-lg">visibility</span>
                                    </button>
                                    <button class="p-1.5 text-slate-400 hover:text-primary transition-colors" onclick="editSale(${sale.id_vendas})" title="Editar">
                                        <span class="material-symbols-outlined text-lg">edit</span>
                                    </button>
                                    <button class="p-1.5 text-slate-400 hover:text-red-500 transition-colors" onclick="deleteSale(${sale.id_vendas})" title="Excluir">
                                        <span class="material-symbols-outlined text-lg">delete</span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        }

        function updateStats() {
            const stats = state.sales.reduce((acc, sale) => {
                const value = parseFloat(sale.valor_total) || 0;
                acc.total += value;

                if (sale.status_pagamento === 'Pago') {
                    acc.paid += value;
                } else if (sale.status_pagamento === 'Pendente') {
                    acc.pending += value;
                } else if (sale.status_pagamento === 'Parcial') {
                    const paidAmount = (sale.pagamentos || []).reduce((sum, p) => sum + parseFloat(p.valor_pago), 0);
                    acc.partial += (value - paidAmount);
                }

                return acc;
            }, { total: 0, paid: 0, pending: 0, partial: 0 });

            document.getElementById('totalReceivable').textContent = formatCurrency(stats.total);
            document.getElementById('totalPaid').textContent = formatCurrency(stats.paid);
            document.getElementById('totalPending').textContent = formatCurrency(stats.pending);
            document.getElementById('totalPartial').textContent = formatCurrency(stats.partial);
        }

        // Navigation
        async function switchView(view, skipInit = false) {
            state.currentView = view;

            // Toggle sidebar active state for mobile
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.getAttribute('data-view') === view) {
                    item.classList.add('bg-primary/10', 'text-primary');
                    item.classList.remove('text-slate-600', 'dark:text-zinc-400');
                    const icon = item.querySelector('.material-symbols-outlined');
                    if (icon) icon.style.fontVariationSettings = "'FILL' 1";
                } else {
                    item.classList.remove('bg-primary/10', 'text-primary');
                    item.classList.add('text-slate-600', 'dark:text-zinc-400');
                    const icon = item.querySelector('.material-symbols-outlined');
                    if (icon) icon.style.fontVariationSettings = "'FILL' 0";
                }
            });

            // Close sidebar on mobile after choosing a view
            if (window.innerWidth < 768) {
                closeSidebar();
            }

            // Show active view, hide others
            document.querySelectorAll('.view-content').forEach(content => {
                if (content.id === `${view}View`) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });

            // Toggle pagination footer
            const paginationViews = ['clients', 'products', 'categories', 'employees', 'suppliers', 'receivables', 'payables', 'advances'];
            const footer = document.getElementById('paginationFooter');
            if (paginationViews.includes(view)) {
                footer.classList.remove('translate-y-full');
            } else {
                footer.classList.add('translate-y-full');
            }

            // Load data for the view
            if (view === 'receivables') {
                await loadSales();
                updateStats();
            } else if (view === 'clients') {
                await loadClients();
            } else if (view === 'products') {
                await loadProducts();
                await loadCategories();
            } else if (view === 'categories') {
                await loadCategories();
            } else if (view === 'employees') {
                await loadEmployees();
            } else if (view === 'suppliers') {
                await loadSuppliers();
            } else if (view === 'payables') {
                await loadSuppliers();
                await loadPayables();
            } else if (view === 'advances') {
                await loadEmployees();
                await loadAdvances();
            } else if (view === 'sales') {
                if (!skipInit) initNewSale();
                await loadProducts();
                await loadClients();
                // Ensure client select is updated even if skipInit is true
                updateSaleClientSelect();
            }
            updatePaginationFooter();
        }

        function logout() {
            state.token = null;
            state.user = null;
            localStorage.removeItem('token');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');

            // Update user profile info in header
            if (state.user) {
                const userEmailElem = document.getElementById('userEmail');
                const userNameElem = document.getElementById('userName');
                const userAvatarElem = document.getElementById('userAvatar');

                if (userEmailElem) userEmailElem.textContent = state.user.email;
                if (userNameElem) userNameElem.textContent = state.user.nome || state.user.email.split('@')[0];
                if (userAvatarElem) userAvatarElem.textContent = (state.user.nome || state.user.email).charAt(0).toUpperCase();
            }

            // Carregar a visualização inicial (receivables) com toda a lógica de UI
            switchView(state.currentView);
            // Carregar clientes em paralelo pois são usados em várias partes (filtros, nomes nas tabelas)
            loadClients();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebarBackdrop');
            const isHidden = sidebar.classList.contains('-translate-x-full');

            if (isHidden) {
                sidebar.classList.remove('-translate-x-full');
                backdrop.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                backdrop.classList.add('hidden');
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebarBackdrop');
            sidebar.classList.add('-translate-x-full');
            backdrop.classList.add('hidden');
        }

        // Dark Mode
        function toggleDarkMode() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');
            const icon = document.querySelector('#darkModeToggle span');

            if (isDark) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                if (icon) icon.textContent = 'dark_mode';
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                if (icon) icon.textContent = 'light_mode';
            }
        }

        async function loginSubmit(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            try {
                errorDiv.classList.add('hidden');
                await login(email, password);

                // Fetch user info following login
                const user = await apiRequest('/login/me');
                state.user = user;

                showMainApp();
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            }
        }

        // Event Listeners
        document.getElementById('loginForm').addEventListener('submit', loginSubmit);

        document.getElementById('payableForm').addEventListener('submit', savePayable);
        document.getElementById('addSalePaymentForm').addEventListener('submit', addSalePayment);
        document.getElementById('batchPaymentForm').addEventListener('submit', processBatchPayment);
        document.getElementById('openFiltersBtn').addEventListener('click', openFilterModal);

        document.getElementById('logoutBtn').addEventListener('click', logout);

        document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);

        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const view = item.getAttribute('data-view');
                switchView(view);
            });
        });



        // Client event listeners
        const newClientBtn = document.getElementById('newClientBtn');
        if (newClientBtn) {
            newClientBtn.addEventListener('click', () => {
                openClientModal();
            });
        }

        const clientForm = document.getElementById('clientForm');
        if (clientForm) {
            clientForm.addEventListener('submit', saveClient);
        }

        // Close modals on background click
        document.getElementById('clientModal').addEventListener('click', (e) => {
            if (e.target.id === 'clientModal') {
                closeClientModal();
            }
        });

        document.getElementById('deleteClientModal').addEventListener('click', (e) => {
            if (e.target.id === 'deleteClientModal') {
                closeDeleteClientModal();
            }
        });

        // Pagination events
        document.getElementById('prevPageBtn').addEventListener('click', () => {
            let config;
            if (state.currentView === 'clients') config = state.pagination.clients;
            else if (state.currentView === 'products') config = state.pagination.products;
            else if (state.currentView === 'categories') config = state.pagination.categories;
            else if (state.currentView === 'employees') config = state.pagination.employees;
            else if (state.currentView === 'suppliers') config = state.pagination.suppliers;
            else if (state.currentView === 'payables') config = state.pagination.payables;

            if (config && config.currentPage > 1) {
                goToPage(config.currentPage - 1);
            }
        });

        document.getElementById('nextPageBtn').addEventListener('click', () => {
            let config;
            if (state.currentView === 'clients') config = state.pagination.clients;
            else if (state.currentView === 'products') config = state.pagination.products;
            else if (state.currentView === 'categories') config = state.pagination.categories;
            else if (state.currentView === 'employees') config = state.pagination.employees;
            else if (state.currentView === 'suppliers') config = state.pagination.suppliers;
            else if (state.currentView === 'payables') config = state.pagination.payables;

            if (config) {
                const totalPages = Math.ceil(config.totalItems / config.itemsPerPage) || 1;
                if (config.currentPage < totalPages) {
                    goToPage(config.currentPage + 1);
                }
            }
        });

        document.getElementById('itemsPerPageSelect').addEventListener('change', (e) => {
            const val = parseInt(e.target.value);
            state.pagination.clients.itemsPerPage = val;
            state.pagination.products.itemsPerPage = val;
            state.pagination.categories.itemsPerPage = val;
            state.pagination.employees.itemsPerPage = val;
            state.pagination.suppliers.itemsPerPage = val;
            state.pagination.receivables.itemsPerPage = val;
            state.pagination.payables.itemsPerPage = val;

            state.pagination.clients.currentPage = 1;
            state.pagination.products.currentPage = 1;
            state.pagination.categories.currentPage = 1;
            state.pagination.employees.currentPage = 1;
            state.pagination.suppliers.currentPage = 1;
            state.pagination.receivables.currentPage = 1;
            state.pagination.payables.currentPage = 1;

            if (state.currentView === 'clients') renderClients();
            if (state.currentView === 'products') renderProducts();
            if (state.currentView === 'categories') renderCategories();
            if (state.currentView === 'employees') renderEmployees();
            if (state.currentView === 'suppliers') renderSuppliers();
            if (state.currentView === 'payables') renderPayables();
            updatePaginationFooter();
        });

        // View Mode Toggle events
        function updateSalesViewMode(mode) {
            state.salesViewMode = mode;
            const gridBtn = document.getElementById('salesGridViewBtn');
            const tableBtn = document.getElementById('salesTableViewBtn');

            if (mode === 'grid') {
                gridBtn.classList.add('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                gridBtn.classList.remove('text-slate-400');
                tableBtn.classList.remove('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                tableBtn.classList.add('text-slate-400');
            } else {
                tableBtn.classList.add('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                tableBtn.classList.remove('text-slate-400');
                gridBtn.classList.remove('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                gridBtn.classList.add('text-slate-400');
            }
            renderSales();
        }

        document.getElementById('salesGridViewBtn').addEventListener('click', () => updateSalesViewMode('grid'));
        document.getElementById('salesTableViewBtn').addEventListener('click', () => updateSalesViewMode('table'));

        function updatePayablesViewMode(mode) {
            state.payablesViewMode = mode;
            const gridBtn = document.getElementById('payablesGridViewBtn');
            const tableBtn = document.getElementById('payablesTableViewBtn');
            const grid = document.getElementById('payablesGrid');
            const tableContainer = document.getElementById('payablesTableContainer');

            if (mode === 'grid') {
                gridBtn.classList.add('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                gridBtn.classList.remove('text-slate-400');
                tableBtn.classList.remove('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                tableBtn.classList.add('text-slate-400');
                grid.classList.remove('hidden');
                tableContainer.classList.add('hidden');
            } else {
                tableBtn.classList.add('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                tableBtn.classList.remove('text-slate-400');
                gridBtn.classList.remove('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                gridBtn.classList.add('text-slate-400');
                grid.classList.add('hidden');
                tableContainer.classList.remove('hidden');
            }
            renderPayables();
        }

        document.getElementById('payablesGridViewBtn').addEventListener('click', () => updatePayablesViewMode('grid'));
        document.getElementById('payablesTableViewBtn').addEventListener('click', () => updatePayablesViewMode('table'));

        function updateAdvancesViewMode(mode) {
            state.advancesViewMode = mode;
            const gridBtn = document.getElementById('advancesGridViewBtn');
            const tableBtn = document.getElementById('advancesTableViewBtn');
            const grid = document.getElementById('advancesGrid');
            const tableContainer = document.getElementById('advancesTableContainer');

            if (mode === 'grid') {
                gridBtn.classList.add('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                gridBtn.classList.remove('text-slate-400');
                tableBtn.classList.remove('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                tableBtn.classList.add('text-slate-400');
                grid.classList.remove('hidden');
                tableContainer.classList.add('hidden');
            } else {
                tableBtn.classList.add('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                tableBtn.classList.remove('text-slate-400');
                gridBtn.classList.remove('bg-white', 'dark:bg-zinc-900', 'text-primary', 'shadow-sm');
                gridBtn.classList.add('text-slate-400');
                grid.classList.add('hidden');
                tableContainer.classList.remove('hidden');
            }
            renderAdvances();
        }

        document.getElementById('advancesGridViewBtn').addEventListener('click', () => updateAdvancesViewMode('grid'));
        document.getElementById('advancesTableViewBtn').addEventListener('click', () => updateAdvancesViewMode('table'));

        document.getElementById('clientGridViewBtn').addEventListener('click', () => updateClientViewMode('grid'));
        document.getElementById('clientTableViewBtn').addEventListener('click', () => updateClientViewMode('table'));

        // Product event listeners
        document.getElementById('productForm').addEventListener('submit', saveProduct);
        document.getElementById('categoryForm').addEventListener('submit', saveCategory);
        document.getElementById('productGridViewBtn').addEventListener('click', () => updateProductViewMode('grid'));
        document.getElementById('productTableViewBtn').addEventListener('click', () => updateProductViewMode('table'));

        // Category event listeners
        document.getElementById('categoryGridViewBtn').addEventListener('click', () => updateCategoryViewMode('grid'));
        document.getElementById('categoryTableViewBtn').addEventListener('click', () => updateCategoryViewMode('table'));

        // Employee event listeners
        document.getElementById('employeeForm').addEventListener('submit', saveEmployee);
        document.getElementById('employeeGridViewBtn').addEventListener('click', () => updateEmployeeViewMode('grid'));
        document.getElementById('employeeTableViewBtn').addEventListener('click', () => updateEmployeeViewMode('table'));

        // Supplier event listeners
        document.getElementById('supplierForm').addEventListener('submit', saveSupplier);
        document.getElementById('supplierGridViewBtn').addEventListener('click', () => updateSupplierViewMode('grid'));
        document.getElementById('supplierTableViewBtn').addEventListener('click', () => updateSupplierViewMode('table'));



        // Close modals on background click
        ['productModal', 'deleteProductModal', 'categoryModal', 'deleteCategoryModal', 'employeeModal', 'deleteEmployeeModal', 'supplierModal', 'deleteSupplierModal'].forEach(id => {
            document.getElementById(id).addEventListener('click', (e) => {
                if (e.target.id === id) {
                    if (id === 'productModal') closeProductModal();
                    if (id === 'deleteProductModal') closeDeleteProductModal();
                    if (id === 'categoryModal') closeCategoryModal();
                    if (id === 'deleteCategoryModal') closeDeleteCategoryModal();
                    if (id === 'employeeModal') closeEmployeeModal();
                    if (id === 'deleteEmployeeModal') closeDeleteEmployeeModal();
                    if (id === 'supplierModal') closeSupplierModal();
                    if (id === 'deleteSupplierModal') closeDeleteSupplierModal();
                }
            });
        });

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            state.searchQuery = e.target.value;
            state.pagination.clients.currentPage = 1;
            state.pagination.products.currentPage = 1;
            state.pagination.categories.currentPage = 1;
            state.pagination.employees.currentPage = 1;
            state.pagination.suppliers.currentPage = 1;
            state.pagination.receivables.currentPage = 1;
            state.pagination.payables.currentPage = 1;
            state.pagination.advances.currentPage = 1;

            if (state.currentView === 'clients') {
                renderClients();
            } else if (state.currentView === 'products') {
                renderProducts();
            } else if (state.currentView === 'categories') {
                renderCategories();
            } else if (state.currentView === 'employees') {
                renderEmployees();
            } else if (state.currentView === 'suppliers') {
                renderSuppliers();
            } else if (state.currentView === 'receivables') {
                renderSales();
            } else if (state.currentView === 'payables') {
                renderPayables();
            } else if (state.currentView === 'advances') {
                renderAdvances();
            }
            updatePaginationFooter();
        }
        );

        // Sale Search and Events
        document.getElementById('saleProductSearch').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const results = document.getElementById('productSearchResults');

            if (query.length < 2) {
                results.classList.add('hidden');
                return;
            }

            const matches = state.products.filter(p =>
                p.nome.toLowerCase().includes(query) ||
                p.id_produto.toString() === query
            ).slice(0, 10);

            if (matches.length > 0) {
                results.innerHTML = matches.map(p => `
                <div onclick='addToSale(${JSON.stringify(p).replace(/'/g, "&#39;")})' class="p-3 hover:bg-slate-50 dark:hover:bg-zinc-700/50 cursor-pointer border-b border-slate-100 dark:border-zinc-700 last:border-0">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="text-sm font-bold text-slate-900 dark:text-white">${p.nome}</div>
                            <div class="text-xs text-slate-500">${p.categoria ? p.categoria.nome : 'Sem categoria'}</div>
                        </div>
                        <div class="text-sm font-black text-primary">${formatCurrency(p.preco_venda)}</div>
                    </div>
                </div>
            `).join('');
                results.classList.remove('hidden');
            } else {
                results.innerHTML = '<div class="p-4 text-center text-sm text-slate-500">Nenhum produto encontrado</div>';
                results.classList.remove('hidden');
            }
        });

        // Close product results when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#saleProductSearch') && !e.target.closest('#productSearchResults')) {
                document.getElementById('productSearchResults').classList.add('hidden');
            }
        });

        document.getElementById('finishSaleBtn').addEventListener('click', finishSale);
        document.getElementById('cancelSaleBtn').addEventListener('click', () => {
            if (confirm('Tem certeza que deseja cancelar esta venda?')) {
                switchView('receivables');
            }
        });


        async function viewSale(id) {
            try {
                const sale = await apiRequest(`/sales/${id}`);
                if (!sale) return;

                document.getElementById('viewSaleTitle').textContent = `Detalhes da Venda #${sale.id_vendas}`;
                document.getElementById('viewSaleDate').textContent = formatDate(sale.data_venda);

                const client = state.clients.find(c => c.id_cliente === sale.id_cliente);
                document.getElementById('viewSaleClient').textContent = client ? client.nome : 'Consumidor Final (Balcão)';

                document.getElementById('viewSalePayment').textContent = `${sale.forma_pagamento || '-'} - ${sale.status_pagamento}`;
                document.getElementById('viewSaleTotal').textContent = formatCurrency(sale.valor_total);

                const body = document.getElementById('viewSaleItemsBody');
                body.innerHTML = sale.itens.map(item => `
                    <tr class="hover:bg-slate-50 dark:hover:bg-zinc-800/50 transition-colors">
                        <td class="px-4 py-3">
                            <div class="flex flex-col">
                                <span class="text-sm font-bold text-slate-900 dark:text-white">${item.produto ? item.produto.nome : 'Produto desconhecido'}</span>
                                <span class="text-[10px] text-slate-400">ID: ${item.id_produto}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-sm text-center font-medium">${parseFloat(item.qtde)}</td>
                        <td class="px-4 py-3 text-sm text-right font-medium">${formatCurrency(item.valor_unitario)}</td>
                        <td class="px-4 py-3 text-sm text-right font-bold text-slate-900 dark:text-white">${formatCurrency(item.subtotal)}</td>
                    </tr>
                `).join('');

                // Fill Payments History
                const paymentsList = document.getElementById('paymentsHistoryList');
                const totalPaid = (sale.pagamentos || []).reduce((acc, p) => acc + parseFloat(p.valor_pago), 0);
                const balance = parseFloat(sale.valor_total) - totalPaid;

                document.getElementById('viewSaleDebt').textContent = formatCurrency(Math.max(0, balance));
                document.getElementById('addPaymentSaleId').value = sale.id_vendas;

                if (!sale.pagamentos || sale.pagamentos.length === 0) {
                    paymentsList.innerHTML = '<p class="text-xs text-slate-400 italic text-center py-4">Nenhum pagamento registrado</p>';
                } else {
                    paymentsList.innerHTML = sale.pagamentos.map(p => `
                        <div class="bg-white dark:bg-zinc-800 p-3 rounded-lg border border-slate-100 dark:border-zinc-700 flex items-center justify-between group">
                            <div>
                                <p class="text-xs font-black text-slate-900 dark:text-white">${formatCurrency(p.valor_pago)}</p>
                                <p class="text-[9px] text-slate-500 uppercase font-bold">${formatDate(p.data_pagamento)} • ${p.forma_pagamento}</p>
                            </div>
                            <button onclick="deleteSalePayment(${p.id_venda_pagamento}, ${sale.id_vendas})" class="text-slate-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100">
                                <span class="material-symbols-outlined text-sm">delete</span>
                            </button>
                        </div>
                    `).join('');
                }

                // Show/Hide Payment Form based on status
                const paymentSection = document.getElementById('addPaymentSection');
                if (sale.status_pagamento === 'Pago') {
                    paymentSection.classList.add('hidden');
                } else {
                    paymentSection.classList.remove('hidden');
                }

                document.getElementById('viewSaleModal').classList.remove('hidden');
            } catch (error) {
                console.error('Erro ao carregar detalhes da venda:', error);
                alert('Erro ao carregar detalhes da venda.');
            }
        }

        function closeViewSaleModal() {
            document.getElementById('viewSaleModal').classList.add('hidden');
        }

        async function editSale(id) {
            console.log("Iniciando edição da venda:", id);
            try {
                const sale = await apiRequest(`/sales/${id}`);
                if (!sale) {
                    console.error("Venda não encontrada retornada da API");
                    return;
                }

                // First switch to the view and ensure dependencies are loaded
                // This will load products and clients and populate the selects
                await switchView('sales', true);

                console.log("View de vendas carregada, populando dados da venda:", sale);

                // Now load sale into state
                state.currentSale = {
                    id_vendas: sale.id_vendas,
                    id_cliente: sale.id_cliente,
                    forma_pagamento: sale.forma_pagamento,
                    status_pagamento: sale.status_pagamento,
                    valor_total: sale.valor_total,
                    itens: sale.itens.map(item => ({
                        id_produto: item.id_produto,
                        nome: item.produto ? item.produto.nome : 'Produto desconhecido',
                        qtde: parseFloat(item.qtde),
                        preco_venda: parseFloat(item.valor_unitario)
                    }))
                };

                // Now that the view is correct and options are injected, populate the fields
                const clientSelect = document.getElementById('saleClientSelect');
                if (clientSelect) {
                    const defaultClient = state.clients.find(c => c.nome === "Consumidor Final");
                    const defaultId = defaultClient ? defaultClient.id_cliente : "";

                    // If sale.id_cliente is null/undefined, we might want to default to the "Consumidor Final" ID
                    // but for compatibility with existing null records, we check both.
                    const targetClientId = (sale.id_cliente === null || sale.id_cliente === undefined) ? defaultId : sale.id_cliente;

                    clientSelect.value = targetClientId;
                    console.log("Cliente selecionado no select (ID):", clientSelect.value);
                }

                const methodSelect = document.getElementById('salePaymentMethod');
                if (methodSelect) methodSelect.value = sale.forma_pagamento || "Dinheiro";

                const statusSelect = document.getElementById('salePaymentStatus');
                if (statusSelect) statusSelect.value = sale.status_pagamento || "Pago";

                // Refresh the items table
                renderSaleItems();

                // Change button text to indicate update mode
                const btn = document.getElementById('finishSaleBtn');
                if (btn) btn.innerHTML = '<span class="material-symbols-outlined">save</span> Atualizar Venda';

                console.log("Edição de venda preparada com sucesso");
            } catch (error) {
                console.error('Erro ao editar venda:', error);
                alert('Erro ao carregar venda para edição: ' + error.message);
            }
        }

        async function deleteSale(id) {
            if (!confirm(`Tem certeza que deseja excluir a venda #${id}? Esta ação não pode ser desfeita.`)) {
                return;
            }

            try {
                await apiRequest(`/sales/${id}`, { method: 'DELETE' });
                alert('Venda excluída com sucesso!');
                await loadSales();
            } catch (error) {
                console.error('Erro ao excluir venda:', error);
                alert('Erro ao excluir venda: ' + error.message);
            }
        }

        // Filter Logic
        function openFilterModal() {
            document.getElementById('filterStartDate').value = state.filters.sales.startDate;
            document.getElementById('filterEndDate').value = state.filters.sales.endDate;
            document.getElementById('filterStatus').value = state.filters.sales.status;
            document.getElementById('filterPaymentMethod').value = state.filters.sales.paymentMethod;

            // Populate clients in filter
            const filterClientSelect = document.getElementById('filterClient');
            if (filterClientSelect) {
                const options = state.clients.map(c => `
                    <option value="${c.id_cliente}">${c.nome}</option>
                `).join('');
                filterClientSelect.innerHTML = '<option value="">Todos os Clientes</option>' + options;
                filterClientSelect.value = state.filters.sales.clientId;
            }

            document.getElementById('filterSalesModal').classList.remove('hidden');
        }

        function closeFilterModal() {
            document.getElementById('filterSalesModal').classList.add('hidden');
        }

        function applyFilters() {
            state.filters.sales.startDate = document.getElementById('filterStartDate').value;
            state.filters.sales.endDate = document.getElementById('filterEndDate').value;
            state.filters.sales.status = document.getElementById('filterStatus').value;
            state.filters.sales.paymentMethod = document.getElementById('filterPaymentMethod').value;
            state.filters.sales.clientId = document.getElementById('filterClient').value;

            renderSales();
            closeFilterModal();

            // Visual feedback on filter button if filters are active
            const hasFilters = Object.values(state.filters.sales).some(v => v !== '');
            const filterBtn = document.getElementById('openFiltersBtn');
            if (hasFilters) {
                filterBtn.classList.add('bg-primary/10', 'text-primary', 'border-primary');
            } else {
                filterBtn.classList.remove('bg-primary/10', 'text-primary', 'border-primary');
            }
        }

        function clearFilters() {
            state.filters.sales = {
                startDate: '',
                endDate: '',
                status: '',
                paymentMethod: '',
                clientId: ''
            };

            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterPaymentMethod').value = '';
            document.getElementById('filterClient').value = '';

            renderSales();
            closeFilterModal();

            const filterBtn = document.getElementById('openFiltersBtn');
            if (filterBtn) filterBtn.classList.remove('bg-primary/10', 'text-primary', 'border-primary');
        }

        // Payables Logic
        async function loadPayables() {
            try {
                const response = await apiRequest('/finance/accounts-payable/');
                if (response) {
                    state.payables = response;
                    renderPayables();
                    updatePayableStats();
                }
            } catch (error) {
                console.error('Erro ao carregar contas a pagar:', error);
            }
        }

        function renderPayables() {
            const tbody = document.getElementById('payablesTableBody');
            const grid = document.getElementById('payablesGrid');
            if (!tbody || !grid) return;

            const filtered = state.payables.filter(ap => {
                const supplier = state.suppliers.find(s => s.id_fornecedor === ap.id_fornecedor);
                const supplierName = supplier ? supplier.nome : 'Sem Fornecedor';

                const matchesSearch = !state.searchQuery ||
                    supplierName.toLowerCase().includes(state.searchQuery.toLowerCase()) ||
                    (ap.numero_nota && ap.numero_nota.toLowerCase().includes(state.searchQuery.toLowerCase()));

                if (!matchesSearch) return false;

                const dueDate = ap.data_vencimento;
                if (state.filters.payables.startDate && dueDate < state.filters.payables.startDate) return false;
                if (state.filters.payables.endDate && dueDate > state.filters.payables.endDate) return false;
                if (state.filters.payables.status && ap.status !== state.filters.payables.status) return false;
                if (state.filters.payables.supplierId && ap.id_fornecedor?.toString() !== state.filters.payables.supplierId.toString()) return false;

                return true;
            });

            // Update pagination
            state.pagination.payables.totalItems = filtered.length;
            const { currentPage, itemsPerPage } = state.pagination.payables;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedPayables = filtered.slice(startIndex, endIndex);

            if (filtered.length === 0) {
                const emptyMsg = `<div class="col-span-full py-12 text-center text-slate-500 italic">Nenhuma conta encontrada</div>`;
                tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-slate-500 italic">Nenhuma conta encontrada</td></tr>`;
                grid.innerHTML = emptyMsg;
                updatePaginationFooter();
                return;
            }

            if (state.payablesViewMode === 'table') {
                tbody.innerHTML = paginatedPayables.map(ap => {
                    const supplier = state.suppliers.find(s => s.id_fornecedor === ap.id_fornecedor);
                    return `
                        <tr class="hover:bg-slate-50 dark:hover:bg-zinc-800/50 transition-colors">
                            <td class="px-6 py-4 text-sm font-bold text-slate-900 dark:text-white">${formatSimpleDate(ap.data_vencimento)}</td>
                            <td class="px-6 py-4 text-sm text-slate-700 dark:text-zinc-300 font-medium">${supplier ? supplier.nome : 'Sem Fornecedor'}</td>
                            <td class="px-6 py-4 text-sm text-center text-slate-500 font-mono text-xs">${ap.numero_nota || '-'}</td>
                            <td class="px-6 py-4 text-sm font-black text-rose-600 dark:text-rose-400">${formatCurrency(ap.valor_total_nota)}</td>
                            <td class="px-6 py-4 text-center">
                                <span class="status-badge ${getStatusClass(ap.status)}">${ap.status}</span>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <div class="flex justify-end gap-1">
                                    <button class="p-1.5 text-slate-400 hover:text-primary transition-colors" onclick="editPayable(${ap.id_contas_pagar})" title="Editar">
                                        <span class="material-symbols-outlined text-lg">edit</span>
                                    </button>
                                    <button class="p-1.5 text-slate-400 hover:text-red-500 transition-colors" onclick="deletePayable(${ap.id_contas_pagar})" title="Excluir">
                                        <span class="material-symbols-outlined text-lg">delete</span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            } else {
                grid.innerHTML = paginatedPayables.map(ap => {
                    const supplier = state.suppliers.find(s => s.id_fornecedor === ap.id_fornecedor);
                    return `
                        <div class="bg-white dark:bg-zinc-900 rounded-2xl border border-slate-200 dark:border-zinc-800 p-5 shadow-sm hover:shadow-md transition-all card-hover flex flex-col">
                            <div class="flex justify-between items-start mb-4">
                                <div class="size-10 rounded-xl bg-rose-100 dark:bg-rose-900/20 text-rose-600 dark:text-rose-400 flex items-center justify-center">
                                    <span class="material-symbols-outlined">payments</span>
                                </div>
                                <span class="status-badge ${getStatusClass(ap.status)}">${ap.status}</span>
                            </div>
                            
                            <div class="mb-4">
                                <h4 class="text-sm font-bold text-slate-500 dark:text-zinc-500 uppercase tracking-wider mb-1">Fornecedor</h4>
                                <p class="text-base font-black text-slate-900 dark:text-white truncate">${supplier ? supplier.nome : 'Sem Fornecedor'}</p>
                            </div>

                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div>
                                    <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Vencimento</h4>
                                    <p class="text-sm font-bold text-slate-700 dark:text-zinc-300">${formatSimpleDate(ap.data_vencimento)}</p>
                                </div>
                                <div>
                                    <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Valor</h4>
                                    <p class="text-lg font-black text-rose-600 dark:text-rose-400">${formatCurrency(ap.valor_total_nota)}</p>
                                </div>
                            </div>

                            <div class="pt-4 border-t border-slate-100 dark:border-zinc-800 flex justify-between items-center mt-auto">
                                <span class="text-[10px] font-mono text-slate-400">DOC: ${ap.numero_nota || '-'}</span>
                                <div class="flex gap-2">
                                    <button onclick="editPayable(${ap.id_contas_pagar})" class="size-8 rounded-lg bg-slate-50 dark:bg-zinc-800 text-slate-400 hover:text-primary hover:bg-primary/10 flex items-center justify-center transition-colors">
                                        <span class="material-symbols-outlined text-lg">edit</span>
                                    </button>
                                    <button onclick="deletePayable(${ap.id_contas_pagar})" class="size-8 rounded-lg bg-slate-50 dark:bg-zinc-800 text-slate-400 hover:text-red-500 hover:bg-red-50 flex items-center justify-center transition-colors">
                                        <span class="material-symbols-outlined text-lg">delete</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            updatePaginationFooter();
        }



        function updatePayableStats() {
            const stats = state.payables.reduce((acc, ap) => {
                const val = parseFloat(ap.valor_total_nota) || 0;
                acc.total += val;
                if (ap.status === 'Pago') acc.paid += val;
                else acc.pending += val;
                return acc;
            }, { total: 0, paid: 0, pending: 0 });

            document.getElementById('totalPayable').textContent = formatCurrency(stats.total);
            document.getElementById('totalPayablePaid').textContent = formatCurrency(stats.paid);
            document.getElementById('totalPayablePending').textContent = formatCurrency(stats.pending);
            document.getElementById('totalPayableCount').textContent = state.payables.length;
        }

        function openPayableModal(id = null) {
            const supplierSelect = document.getElementById('payableSupplier');
            supplierSelect.innerHTML = '<option value="">Selecione um fornecedor</option>' +
                state.suppliers.map(s => `<option value="${s.id_fornecedor}">${s.nome}</option>`).join('');

            if (id) {
                const ap = state.payables.find(a => a.id_contas_pagar === id);
                document.getElementById('payableModalTitle').textContent = 'Editar Conta';
                document.getElementById('payableId').value = ap.id_contas_pagar;
                document.getElementById('payableSupplier').value = ap.id_fornecedor || '';
                document.getElementById('payableInvoiceNumber').value = ap.numero_nota || '';
                document.getElementById('payableDueDate').value = ap.data_vencimento;
                document.getElementById('payableTotalValue').value = ap.valor_total_nota;
                document.getElementById('payableStatus').value = ap.status;
            } else {
                document.getElementById('payableModalTitle').textContent = 'Nova Conta a Pagar';
                document.getElementById('payableForm').reset();
                document.getElementById('payableId').value = '';
            }
            document.getElementById('payableModal').classList.remove('hidden');
        }

        function closePayableModal() {
            document.getElementById('payableModal').classList.add('hidden');
        }

        async function savePayable(e) {
            e.preventDefault();
            const id = document.getElementById('payableId').value;
            const data = {
                id_fornecedor: document.getElementById('payableSupplier').value ? parseInt(document.getElementById('payableSupplier').value) : null,
                numero_nota: document.getElementById('payableInvoiceNumber').value,
                data_vencimento: document.getElementById('payableDueDate').value,
                valor_total_nota: parseFloat(document.getElementById('payableTotalValue').value),
                status: document.getElementById('payableStatus').value,
                itens: []
            };

            try {
                const method = id ? 'PUT' : 'POST';
                const url = id ? `/finance/accounts-payable/${id}` : '/finance/accounts-payable/';
                await apiRequest(url, { method, body: JSON.stringify(data) });
                alert('Conta salva com sucesso!');
                closePayableModal();
                loadPayables();
            } catch (error) {
                alert('Erro ao salvar conta: ' + error.message);
            }
        }

        function editPayable(id) {
            openPayableModal(id);
        }

        async function deletePayable(id) {
            if (!confirm(`Excluir conta #${id}?`)) return;
            try {
                await apiRequest(`/finance/accounts-payable/${id}`, { method: 'DELETE' });
                loadPayables();
            } catch (error) {
                alert('Erro ao excluir: ' + error.message);
            }
        }

        // Filter Modals Payables
        function openFilterPayablesModal() {
            const supSelect = document.getElementById('filterPayableSupplier');
            supSelect.innerHTML = '<option value="">Todos os Fornecedores</option>' +
                state.suppliers.map(s => `<option value="${s.id_fornecedor}">${s.nome}</option>`).join('');

            document.getElementById('filterPayableStartDate').value = state.filters.payables.startDate;
            document.getElementById('filterPayableEndDate').value = state.filters.payables.endDate;
            document.getElementById('filterPayableStatus').value = state.filters.payables.status;
            document.getElementById('filterPayableSupplier').value = state.filters.payables.supplierId;

            document.getElementById('filterPayablesModal').classList.remove('hidden');
        }

        function closeFilterPayablesModal() {
            document.getElementById('filterPayablesModal').classList.add('hidden');
        }

        function applyPayableFilters() {
            state.filters.payables.startDate = document.getElementById('filterPayableStartDate').value;
            state.filters.payables.endDate = document.getElementById('filterPayableEndDate').value;
            state.filters.payables.status = document.getElementById('filterPayableStatus').value;
            state.filters.payables.supplierId = document.getElementById('filterPayableSupplier').value;
            renderPayables();
            closeFilterPayablesModal();
        }

        function clearPayableFilters() {
            state.filters.payables = { startDate: '', endDate: '', status: '', supplierId: '' };
            renderPayables();
            closeFilterPayablesModal();
        }

        // Initialize
        function init() {
            // Check for saved theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
                const icon = document.querySelector('#darkModeToggle span');
                if (icon) icon.textContent = 'light_mode';
            }

            // Check for saved token
            const savedToken = localStorage.getItem('token');
            if (savedToken) {
                state.token = savedToken;
                // Validate token and fetch user info
                apiRequest('/login/me')
                    .then(user => {
                        state.user = user;
                        showMainApp();
                    })
                    .catch(err => {
                        console.error('Token validation failed:', err);
                        logout();
                    });
            }

            // Initialize View Modes
            updateClientViewMode('grid');
            updateProductViewMode('grid');
            updateCategoryViewMode('grid');
            updateEmployeeViewMode('grid');
            updateSupplierViewMode('grid');
            updateSalesViewMode('grid');
            updatePayablesViewMode(state.payablesViewMode);
            updateAdvancesViewMode(state.advancesViewMode);
        }

        async function addSalePayment(e) {
            e.preventDefault();
            const saleId = document.getElementById('addPaymentSaleId').value;
            const data = {
                valor_pago: parseFloat(document.getElementById('addPaymentValue').value),
                forma_pagamento: document.getElementById('addPaymentMethod').value,
                observacao: "Recebimento parcial/final"
            };

            try {
                await apiRequest(`/sales/${saleId}/payments`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                alert('Pagamento registrado com sucesso!');
                document.getElementById('addSalePaymentForm').reset();

                await loadSales();
                viewSale(parseInt(saleId));
            } catch (error) {
                console.error('Erro ao registrar pagamento:', error);
                alert('Erro ao registrar pagamento: ' + error.message);
            }
        }

        async function deleteSalePayment(paymentId, saleId) {
            if (!confirm('Excluir este registro de pagamento?')) return;
            try {
                await apiRequest(`/sales/payments/${paymentId}`, { method: 'DELETE' });
                await loadSales();
                viewSale(saleId);
            } catch (error) {
                alert('Erro ao excluir: ' + error.message);
            }
        }

        // Batch Payment Logic
        function openBatchPaymentModal(id, name) {
            const client = state.clients.find(c => c.id_cliente === id);
            document.getElementById('batchPaymentDebt').textContent = formatCurrency(client ? client.saldo_devedor : 0);

            document.getElementById('batchPaymentClientId').value = id;
            document.getElementById('batchPaymentClientName').textContent = name;
            document.getElementById('batchPaymentForm').reset();
            document.getElementById('batchPaymentModal').classList.remove('hidden');
        }

        function closeBatchPaymentModal() {
            document.getElementById('batchPaymentModal').classList.add('hidden');
        }

        async function processBatchPayment(e) {
            e.preventDefault();
            const clientId = document.getElementById('batchPaymentClientId').value;
            const data = {
                valor_total: parseFloat(document.getElementById('batchPaymentValue').value),
                forma_pagamento: document.getElementById('batchPaymentMethod').value,
                observacao: document.getElementById('batchPaymentObs').value || "Baixa Automática (FIFO)"
            };

            try {
                const result = await apiRequest(`/sales/batch-payment/${clientId}`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                alert(`Sucesso! Foram liquidados/abatidos ${formatCurrency(result.distributed_amount)}.`);
                closeBatchPaymentModal();

                // Refresh data globally
                await loadSales();
                await loadClients();

                if (state.currentView === 'receivables') updateStats();
                if (state.currentView === 'clients') renderClients();

            } catch (error) {
                console.error('Erro ao processar baixa em lote:', error);
                alert('Erro ao processar baixa: ' + (error.message || "Verifique se o cliente possui notas em aberto."));
            }
        }

        // Advances Logic
        async function loadAdvances() {
            try {
                const response = await apiRequest('/finance/advances/');
                if (response) {
                    state.advances = response;
                    renderAdvances();
                    updateAdvanceStats();
                }
            } catch (error) {
                console.error('Erro ao carregar adiantamentos:', error);
            }
        }

        function renderAdvances() {
            const tbody = document.getElementById('advancesTableBody');
            const grid = document.getElementById('advancesGrid');
            if (!tbody || !grid) return;

            const filtered = state.advances.filter(adv => {
                const employee = state.employees.find(e => e.id_funcionario === adv.id_funcionario);
                const empName = employee ? employee.nome : 'Desconhecido';

                // Search Query
                const matchesSearch = !state.searchQuery ||
                    empName.toLowerCase().includes(state.searchQuery.toLowerCase());
                if (!matchesSearch) return false;

                // Filters
                const date = adv.data_registro ? adv.data_registro.split('T')[0] : '';
                if (state.filters.advances.startDate && date && date < state.filters.advances.startDate) return false;
                if (state.filters.advances.endDate && date && date > state.filters.advances.endDate) return false;
                if (state.filters.advances.type && getAdvanceTypeLabel(adv.tipo) !== state.filters.advances.type) return false;
                if (state.filters.advances.employeeId && adv.id_funcionario && adv.id_funcionario.toString() !== state.filters.advances.employeeId.toString()) return false;

                return true;
            });

            // Pagination
            state.pagination.advances.totalItems = filtered.length;
            const { currentPage, itemsPerPage } = state.pagination.advances;
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginated = filtered.slice(start, end);

            if (filtered.length === 0) {
                const emptyMsg = `<div class="col-span-full py-12 text-center text-slate-500 italic">Nenhum registro encontrado</div>`;
                tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-slate-500 italic">Nenhum registro encontrado</td></tr>`;
                grid.innerHTML = emptyMsg;
                updatePaginationFooter();
                return;
            }

            if (state.advancesViewMode === 'table') {
                tbody.innerHTML = paginated.map(adv => {
                    const employee = state.employees.find(e => String(e.id_funcionario) === String(adv.id_funcionario));
                    return `
                        <tr class="hover:bg-slate-50 dark:hover:bg-zinc-800/50 transition-colors border-b border-slate-100 dark:border-zinc-800/50">
                            <td class="px-6 py-4 text-sm text-slate-600 dark:text-zinc-400">${formatSimpleDate(adv.data_registro)}</td>
                            <td class="px-6 py-4 text-sm font-bold text-slate-900 dark:text-white capitalize">${employee ? employee.nome : 'N/A'}</td>
                            <td class="px-6 py-4 text-sm text-slate-600 dark:text-zinc-400">
                                <span class="inline-block px-2 py-0.5 rounded text-[10px] uppercase font-black border ${getAdvanceTypeClass(adv.tipo)}">
                                    ${getAdvanceTypeLabel(adv.tipo)}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-sm text-slate-600 dark:text-zinc-400">${adv.mes_referencia || '-'}</td>
                            <td class="px-6 py-4 text-sm font-black text-slate-900 dark:text-white">${formatCurrency(adv.valor)}</td>
                            <td class="px-6 py-4 text-right">
                                <div class="flex justify-end gap-1">
                                    <button onclick="editAdvance(${adv.id_lancamento})" class="p-1.5 text-slate-400 hover:text-primary transition-colors">
                                        <span class="material-symbols-outlined text-lg">edit</span>
                                    </button>
                                    <button onclick="deleteAdvance(${adv.id_lancamento})" class="p-1.5 text-slate-400 hover:text-red-500 transition-colors">
                                        <span class="material-symbols-outlined text-lg">delete</span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                grid.innerHTML = '';
            } else {
                grid.innerHTML = paginated.map(adv => {
                    const employee = state.employees.find(e => String(e.id_funcionario) === String(adv.id_funcionario));
                    return `
                        <div class="bg-white dark:bg-zinc-900 rounded-2xl border border-slate-200 dark:border-zinc-800 p-5 shadow-sm hover:shadow-md transition-all card-hover flex flex-col">
                            <div class="flex justify-between items-start mb-4">
                                <div class="size-10 rounded-xl bg-indigo-100 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400 flex items-center justify-center">
                                    <span class="material-symbols-outlined">payments</span>
                                </div>
                                <span class="status-badge text-[10px] font-black border ${getAdvanceTypeClass(adv.tipo)}">${getAdvanceTypeLabel(adv.tipo)}</span>
                            </div>
                            
                            <div class="mb-4">
                                <h4 class="text-sm font-bold text-slate-500 dark:text-zinc-500 uppercase tracking-wider mb-1">Funcionário</h4>
                                <p class="text-base font-black text-slate-900 dark:text-white truncate">${employee ? employee.nome : 'N/A'}</p>
                            </div>

                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div>
                                    <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Data</h4>
                                    <p class="text-sm font-bold text-slate-700 dark:text-zinc-300">${formatSimpleDate(adv.data_registro)}</p>
                                </div>
                                <div>
                                    <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Valor</h4>
                                    <p class="text-lg font-black text-indigo-600 dark:text-indigo-400">${formatCurrency(adv.valor)}</p>
                                </div>
                            </div>

                            <div class="pt-4 border-t border-slate-100 dark:border-zinc-800 flex justify-between items-center mt-auto">
                                <span class="text-[10px] font-mono text-slate-400">REF: ${adv.mes_referencia || '-'}</span>
                                <div class="flex gap-2">
                                    <button onclick="editAdvance(${adv.id_lancamento})" class="size-8 rounded-lg bg-slate-50 dark:bg-zinc-800 text-slate-400 hover:text-primary hover:bg-primary/10 flex items-center justify-center transition-colors">
                                        <span class="material-symbols-outlined text-lg">edit</span>
                                    </button>
                                    <button onclick="deleteAdvance(${adv.id_lancamento})" class="size-8 rounded-lg bg-slate-50 dark:bg-zinc-800 text-slate-400 hover:text-red-500 hover:bg-red-50 flex items-center justify-center transition-colors">
                                        <span class="material-symbols-outlined text-lg">delete</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                tbody.innerHTML = '';
            }

            updatePaginationFooter();
        }

        function updateAdvanceStats() {
            const total = state.advances.reduce((sum, adv) => sum + parseFloat(adv.valor), 0);
            document.getElementById('totalAdvances').textContent = formatCurrency(total);

            // Current month ref
            const now = new Date();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            document.getElementById('advancesRefMonth').textContent = `${month}/${year}`;
        }

        function openAdvanceModal(id = null) {
            // Populate employees
            const select = document.getElementById('advanceEmployee');
            select.innerHTML = '<option value="">Selecione...</option>' +
                state.employees.map(e => `<option value="${e.id_funcionario}">${e.nome}</option>`).join('');

            // Set default month
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            if (id) {
                const adv = state.advances.find(a => a.id_lancamento === id);
                document.getElementById('advanceModalTitle').textContent = 'Editar Adiantamento';
                document.getElementById('advanceId').value = adv.id_lancamento;
                document.getElementById('advanceEmployee').value = adv.id_funcionario;
                document.getElementById('advanceType').value = adv.tipo;
                document.getElementById('advanceValue').value = adv.valor;
                document.getElementById('advanceRefMonth').value = adv.mes_referencia || currentMonth;
            } else {
                document.getElementById('advanceModalTitle').textContent = 'Novo Adiantamento';
                document.getElementById('advanceForm').reset();
                document.getElementById('advanceId').value = '';
                document.getElementById('advanceRefMonth').value = currentMonth;
            }
            document.getElementById('advanceModal').classList.remove('hidden');
        }

        function closeAdvanceModal() {
            document.getElementById('advanceModal').classList.add('hidden');
        }

        document.getElementById('advanceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('advanceId').value;
            const data = {
                id_funcionario: parseInt(document.getElementById('advanceEmployee').value),
                tipo: document.getElementById('advanceType').value,
                valor: parseFloat(document.getElementById('advanceValue').value),
                mes_referencia: document.getElementById('advanceRefMonth').value
            };

            try {
                const method = id ? 'PUT' : 'POST';
                const url = id ? `/finance/advances/${id}` : '/finance/advances/';
                await apiRequest(url, { method, body: JSON.stringify(data) });

                alert('Salvo com sucesso!');
                closeAdvanceModal();
                loadAdvances();
            } catch (error) {
                alert('Erro ao salvar: ' + error.message);
            }
        });

        function editAdvance(id) {
            openAdvanceModal(id);
        }

        function deleteAdvance(id) {
            document.getElementById('confirmDeleteAdvanceBtn').onclick = async () => {
                try {
                    await apiRequest(`/finance/advances/${id}`, { method: 'DELETE' });
                    document.getElementById('deleteAdvanceModal').classList.add('hidden');
                    loadAdvances();
                } catch (error) {
                    alert('Erro ao excluir: ' + error.message);
                }
            };
            document.getElementById('deleteAdvanceModal').classList.remove('hidden');
        }

        function closeDeleteAdvanceModal() {
            document.getElementById('deleteAdvanceModal').classList.add('hidden');
        }

        // Filter Advances
        function openFilterAdvancesModal() {
            const select = document.getElementById('filterAdvanceEmployee');
            select.innerHTML = '<option value="">Todos</option>' +
                state.employees.map(e => `<option value="${e.id_funcionario}">${e.nome}</option>`).join('');

            document.getElementById('filterAdvanceStartDate').value = state.filters.advances.startDate;
            document.getElementById('filterAdvanceEndDate').value = state.filters.advances.endDate;
            document.getElementById('filterAdvanceType').value = state.filters.advances.type;
            document.getElementById('filterAdvanceEmployee').value = state.filters.advances.employeeId;

            document.getElementById('filterAdvancesModal').classList.remove('hidden');
        }

        function closeFilterAdvancesModal() {
            document.getElementById('filterAdvancesModal').classList.add('hidden');
        }

        function applyAdvanceFilters() {
            state.filters.advances.startDate = document.getElementById('filterAdvanceStartDate').value;
            state.filters.advances.endDate = document.getElementById('filterAdvanceEndDate').value;
            state.filters.advances.type = document.getElementById('filterAdvanceType').value;
            state.filters.advances.employeeId = document.getElementById('filterAdvanceEmployee').value;
            renderAdvances();
            closeFilterAdvancesModal();

            // Highlight button content
            const hasFilters = Object.values(state.filters.advances).some(v => v !== '');
            const btn = document.getElementById('openFilterAdvancesBtn');
            if (hasFilters) btn.classList.add('text-primary', 'bg-primary/10', 'border-primary');
            else btn.classList.remove('text-primary', 'bg-primary/10', 'border-primary');
        }

        function clearAdvanceFilters() {
            document.getElementById('filterAdvanceStartDate').value = '';
            document.getElementById('filterAdvanceEndDate').value = '';
            document.getElementById('filterAdvanceType').value = '';
            document.getElementById('filterAdvanceEmployee').value = '';

            state.filters.advances = { startDate: '', endDate: '', type: '', employeeId: '' };

            renderAdvances();
            closeFilterAdvancesModal();

            // Reset button style
            const btn = document.getElementById('openFilterAdvancesBtn');
            btn.classList.remove('text-primary', 'bg-primary/10', 'border-primary');
        }

        init();
    </script>
</body>

</html>